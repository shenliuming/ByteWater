# ç¬¬ä¸‰è¯¾ï¼šJVMå†…å­˜æ•°æ®åŒºæ·±åº¦è§£æ - è¿è¡Œæ—¶æ•°æ®åŒºçš„è®¾è®¡åŸç†ä¸å®ç°æœºåˆ¶

> æ·±å…¥ç†è§£JVMè¿è¡Œæ—¶æ•°æ®åŒºçš„è®¾è®¡åŸç†ä¸å®ç°æœºåˆ¶

---

*æœ¬è¯¾ç¨‹åŸºäºOracle JVM Specificationå’ŒOpenJDKæºç ï¼Œç¡®ä¿æŠ€æœ¯å†…å®¹çš„å‡†ç¡®æ€§å’Œæƒå¨æ€§ã€‚*

## å¼€ç¯‡ï¼šä»JVMè§„èŒƒçœ‹å†…å­˜æ¶æ„

æ ¹æ®ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹(JVM Specification)ï¼ŒJVMè¿è¡Œæ—¶æ•°æ®åŒºåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒåŒºåŸŸï¼š

```
JVMè¿è¡Œæ—¶æ•°æ®åŒºæ¶æ„
â”œâ”€â”€ çº¿ç¨‹å…±äº«åŒºåŸŸ
â”‚   â”œâ”€â”€ æ–¹æ³•åŒº(Method Area)
â”‚   â”‚   â”œâ”€â”€ è¿è¡Œæ—¶å¸¸é‡æ± (Runtime Constant Pool)
â”‚   â”‚   â”œâ”€â”€ ç±»å‹ä¿¡æ¯(Type Information)
â”‚   â”‚   â”œâ”€â”€ å­—æ®µä¿¡æ¯(Field Information)
â”‚   â”‚   â”œâ”€â”€ æ–¹æ³•ä¿¡æ¯(Method Information)
â”‚   â”‚   â””â”€â”€ ç±»å˜é‡(Class Variables)
â”‚   â””â”€â”€ å †(Heap)
â”‚       â”œâ”€â”€ å¹´è½»ä»£(Young Generation)
â”‚       â”‚   â”œâ”€â”€ EdenåŒº
â”‚       â”‚   â”œâ”€â”€ Survivor 0åŒº
â”‚       â”‚   â””â”€â”€ Survivor 1åŒº
â”‚       â””â”€â”€ è€å¹´ä»£(Old Generation)
â””â”€â”€ çº¿ç¨‹ç§æœ‰åŒºåŸŸ
    â”œâ”€â”€ ç¨‹åºè®¡æ•°å™¨(PC Register)
    â”œâ”€â”€ Javaè™šæ‹Ÿæœºæ ˆ(JVM Stack)
    â”‚   â””â”€â”€ æ ˆå¸§(Stack Frame)
    â”‚       â”œâ”€â”€ å±€éƒ¨å˜é‡è¡¨(Local Variables)
    â”‚       â”œâ”€â”€ æ“ä½œæ•°æ ˆ(Operand Stack)
    â”‚       â”œâ”€â”€ åŠ¨æ€é“¾æ¥(Dynamic Linking)
    â”‚       â””â”€â”€ æ–¹æ³•è¿”å›åœ°å€(Return Address)
    â””â”€â”€ æœ¬åœ°æ–¹æ³•æ ˆ(Native Method Stack)
```

è®©æˆ‘ä»¬é€šè¿‡å®é™…ä»£ç æ¥è§‚å¯Ÿè¿™äº›å†…å­˜åŒºåŸŸçš„å·¥ä½œæœºåˆ¶ï¼š

```java
// MemoryAreaDemo.java - æ¼”ç¤ºå„å†…å­˜åŒºåŸŸçš„ä½¿ç”¨
public class MemoryAreaDemo {
    // ç±»å˜é‡ - classVariableå¼•ç”¨å­˜å‚¨åœ¨æ–¹æ³•åŒºï¼Œå­—ç¬¦ä¸²å¯¹è±¡"å­˜å‚¨åœ¨æ–¹æ³•åŒº"å­˜å‚¨åœ¨å †ä¸­
    private static String classVariable = "å­˜å‚¨åœ¨æ–¹æ³•åŒº";
    
    // å®ä¾‹å˜é‡ - instanceVariableå¼•ç”¨å­˜å‚¨åœ¨å †ä¸­çš„å¯¹è±¡å†…ï¼Œå­—ç¬¦ä¸²å¯¹è±¡"å­˜å‚¨åœ¨å †ä¸­"å­˜å‚¨åœ¨å †ä¸­
    private String instanceVariable = "å­˜å‚¨åœ¨å †ä¸­";
    
    public static void main(String[] args) {
        // å±€éƒ¨å˜é‡ - localVariableå­˜å‚¨åœ¨è™šæ‹Ÿæœºæ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­
        int localVariable = 42;
        
        // å¯¹è±¡å¼•ç”¨ - demoå¼•ç”¨å­˜å‚¨åœ¨æ ˆä¸­ï¼ŒMemoryAreaDemoå¯¹è±¡å­˜å‚¨åœ¨å †ä¸­
        MemoryAreaDemo demo = new MemoryAreaDemo();
        
        // æ–¹æ³•è°ƒç”¨ - åœ¨è™šæ‹Ÿæœºæ ˆä¸­åˆ›å»ºæ–°çš„æ ˆå¸§
        demo.demonstrateStackFrame(localVariable);
    }
    
    private void demonstrateStackFrame(int parameter) {
        // æ¯ä¸ªæ–¹æ³•è°ƒç”¨éƒ½ä¼šåœ¨è™šæ‹Ÿæœºæ ˆä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§
        // localStringå¼•ç”¨å­˜å‚¨åœ¨æ ˆå¸§çš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œå­—ç¬¦ä¸²å¯¹è±¡å­˜å‚¨åœ¨å †ä¸­
        String localString = "æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡";
        
        // literalå¼•ç”¨å­˜å‚¨åœ¨æ ˆå¸§ä¸­ï¼Œå­—ç¬¦ä¸²å­—é¢é‡"å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²"å­˜å‚¨åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­
        String literal = "å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²";
        
        System.out.println("æ¼”ç¤ºæ ˆå¸§çš„åˆ›å»ºå’Œé”€æ¯");
        // æ–¹æ³•ç»“æŸæ—¶ï¼Œæ ˆå¸§è¢«é”€æ¯ï¼Œä½†å †ä¸­çš„å¯¹è±¡å¯èƒ½ç»§ç»­å­˜åœ¨ç›´åˆ°è¢«GCå›æ”¶
    }
}
```

**é‡è¦è¯´æ˜ï¼šå˜é‡å¼•ç”¨ vs å¯¹è±¡å­˜å‚¨**

åœ¨ç†è§£JVMå†…å­˜åˆ†é…æ—¶ï¼Œå¿…é¡»æ˜ç¡®åŒºåˆ†**å˜é‡å¼•ç”¨**å’Œ**å¯¹è±¡å­˜å‚¨**çš„æ¦‚å¿µï¼š

1. **ç±»å˜é‡ï¼ˆé™æ€å˜é‡ï¼‰**ï¼š
   - `classVariable`å¼•ç”¨æœ¬èº«å­˜å‚¨åœ¨**æ–¹æ³•åŒº**ï¼ˆå…ƒç©ºé—´ï¼‰
   - å­—ç¬¦ä¸²å¯¹è±¡`"å­˜å‚¨åœ¨æ–¹æ³•åŒº"`å®é™…å­˜å‚¨åœ¨**å †å†…å­˜**ä¸­
   - æ–¹æ³•åŒºåªå­˜å‚¨å˜é‡çš„å¼•ç”¨ï¼Œä¸å­˜å‚¨å¯¹è±¡æœ¬èº«

2. **å®ä¾‹å˜é‡**ï¼š
   - `instanceVariable`å¼•ç”¨å­˜å‚¨åœ¨**å †ä¸­çš„å¯¹è±¡å®ä¾‹å†…**
   - å­—ç¬¦ä¸²å¯¹è±¡`"å­˜å‚¨åœ¨å †ä¸­"`å­˜å‚¨åœ¨**å †å†…å­˜**çš„å¦ä¸€ä¸ªä½ç½®
   - å¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®éƒ½åœ¨å †ä¸­ï¼Œä½†å¼•ç”¨çš„ç›®æ ‡å¯¹è±¡å¯èƒ½åœ¨å †çš„ä¸åŒåŒºåŸŸ

3. **å±€éƒ¨å˜é‡**ï¼š
   - åŸºæœ¬ç±»å‹ï¼ˆå¦‚`int localVariable`ï¼‰ï¼šå€¼ç›´æ¥å­˜å‚¨åœ¨**è™šæ‹Ÿæœºæ ˆ**çš„å±€éƒ¨å˜é‡è¡¨ä¸­
   - å¼•ç”¨ç±»å‹ï¼ˆå¦‚`String localString`ï¼‰ï¼šå¼•ç”¨å­˜å‚¨åœ¨**æ ˆ**ä¸­ï¼Œå¯¹è±¡å­˜å‚¨åœ¨**å †**ä¸­

4. **å­—ç¬¦ä¸²å­—é¢é‡**ï¼š
   - å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆå¦‚`"å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²"`ï¼‰å­˜å‚¨åœ¨**è¿è¡Œæ—¶å¸¸é‡æ± **ä¸­
   - å±€éƒ¨å˜é‡`literal`åªæ˜¯ä¸€ä¸ªå¼•ç”¨ï¼ŒæŒ‡å‘å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡

**ä¸“ä¸šæœ¯è¯­è§£é‡Šï¼šä»€ä¹ˆæ˜¯å­—é¢é‡(Literal)ï¼Ÿ**

å­—é¢é‡æ˜¯ç¼–ç¨‹è¯­è¨€ä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯åœ¨æºä»£ç ä¸­ç›´æ¥è¡¨ç¤ºå›ºå®šå€¼çš„ç¬¦å·ã€‚

**å­—é¢é‡çš„å®šä¹‰ï¼š**
- å­—é¢é‡æ˜¯ç¨‹åºä¸­ç›´æ¥å†™å‡ºçš„ã€ä¸éœ€è¦è®¡ç®—å°±èƒ½ç¡®å®šå€¼çš„æ•°æ®
- å®ƒä»¬åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šï¼Œæ˜¯ç¨‹åºçš„"ç¡¬ç¼–ç "éƒ¨åˆ†
- å­—é¢é‡çš„å€¼åœ¨ç¨‹åºè¿è¡ŒæœŸé—´é€šå¸¸ä¸ä¼šæ”¹å˜

**Javaä¸­çš„å­—é¢é‡ç±»å‹ï¼š**

1. **æ•´æ•°å­—é¢é‡**ï¼š
   ```java
   int a = 42;        // åè¿›åˆ¶å­—é¢é‡
   int b = 0x2A;      // åå…­è¿›åˆ¶å­—é¢é‡
   int c = 052;       // å…«è¿›åˆ¶å­—é¢é‡
   int d = 0b101010;  // äºŒè¿›åˆ¶å­—é¢é‡
   ```

2. **æµ®ç‚¹æ•°å­—é¢é‡**ï¼š
   ```java
   double pi = 3.14159;     // åŒç²¾åº¦å­—é¢é‡
   float f = 3.14f;         // å•ç²¾åº¦å­—é¢é‡
   double scientific = 1.23e-4; // ç§‘å­¦è®¡æ•°æ³•å­—é¢é‡
   ```

3. **å­—ç¬¦å­—é¢é‡**ï¼š
   ```java
   char c1 = 'A';           // å­—ç¬¦å­—é¢é‡
   char c2 = '\n';          // è½¬ä¹‰å­—ç¬¦å­—é¢é‡
   char c3 = '\u0041';      // Unicodeå­—é¢é‡
   ```

4. **å­—ç¬¦ä¸²å­—é¢é‡**ï¼š
   ```java
   String s1 = "Hello World";     // å­—ç¬¦ä¸²å­—é¢é‡
   String s2 = "åŒ…å«ä¸­æ–‡çš„å­—ç¬¦ä¸²";   // åŒ…å«Unicodeçš„å­—ç¬¦ä¸²å­—é¢é‡
   ```

5. **å¸ƒå°”å­—é¢é‡**ï¼š
   ```java
   boolean flag1 = true;    // å¸ƒå°”å­—é¢é‡true
   boolean flag2 = false;   // å¸ƒå°”å­—é¢é‡false
   ```

6. **nullå­—é¢é‡**ï¼š
   ```java
   String str = null;       // nullå­—é¢é‡ï¼Œè¡¨ç¤ºç©ºå¼•ç”¨
   ```

**å­—é¢é‡åœ¨JVMä¸­çš„å­˜å‚¨æœºåˆ¶ï¼š**

1. **ç¼–è¯‘æ—¶å¤„ç†**ï¼š
   - å­—é¢é‡åœ¨ç¼–è¯‘æ—¶è¢«è¯†åˆ«å¹¶å¤„ç†
   - ç¼–è¯‘å™¨å°†å­—é¢é‡ä¿¡æ¯å†™å…¥å­—èŠ‚ç æ–‡ä»¶çš„å¸¸é‡æ± ä¸­

2. **è¿è¡Œæ—¶å­˜å‚¨**ï¼š
   - **åŸºæœ¬ç±»å‹å­—é¢é‡**ï¼šç›´æ¥åµŒå…¥åˆ°å­—èŠ‚ç æŒ‡ä»¤ä¸­ï¼Œæˆ–å­˜å‚¨åœ¨å¸¸é‡æ± ä¸­
   - **å­—ç¬¦ä¸²å­—é¢é‡**ï¼šå­˜å‚¨åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œå…·æœ‰å­—ç¬¦ä¸²é©»ç•™æœºåˆ¶
   - **ç±»å­—é¢é‡**ï¼ˆå¦‚`String.class`ï¼‰ï¼šå­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­

3. **å­—ç¬¦ä¸²å­—é¢é‡çš„ç‰¹æ®Šæ€§**ï¼š
   ```java
   String s1 = "Hello";     // å­—é¢é‡ï¼Œå­˜å‚¨åœ¨å¸¸é‡æ± 
   String s2 = "Hello";     // åŒä¸€ä¸ªå­—é¢é‡ï¼ŒæŒ‡å‘å¸¸é‡æ± ä¸­åŒä¸€ä¸ªå¯¹è±¡
   String s3 = new String("Hello"); // éå­—é¢é‡ï¼Œåœ¨å †ä¸­åˆ›å»ºæ–°å¯¹è±¡
   
   System.out.println(s1 == s2);    // trueï¼ŒæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡
   System.out.println(s1 == s3);    // falseï¼Œä¸åŒå¯¹è±¡
   ```

**å­—é¢é‡ vs å˜é‡ vs å¸¸é‡ï¼š**

```java
public class LiteralExample {
    // å¸¸é‡ï¼šä½¿ç”¨finalä¿®é¥°ï¼Œå€¼ä¸å¯æ”¹å˜
    private static final String CONSTANT = "è¿™æ˜¯ä¸€ä¸ªå¸¸é‡";
    
    public void example() {
        // å­—é¢é‡ï¼šæºä»£ç ä¸­ç›´æ¥å†™å‡ºçš„å€¼
        int literal1 = 100;           // 100æ˜¯æ•´æ•°å­—é¢é‡
        String literal2 = "å­—é¢é‡";    // "å­—é¢é‡"æ˜¯å­—ç¬¦ä¸²å­—é¢é‡
        
        // å˜é‡ï¼šå¯ä»¥æ”¹å˜å€¼çš„æ ‡è¯†ç¬¦
        int variable = literal1;      // variableæ˜¯å˜é‡ï¼Œliteral1æ˜¯å­—é¢é‡
        variable = 200;               // å˜é‡å€¼å¯ä»¥æ”¹å˜
        
        // å­—é¢é‡åœ¨è¡¨è¾¾å¼ä¸­çš„ä½¿ç”¨
        int result = literal1 + 50;   // 50ä¹Ÿæ˜¯å­—é¢é‡
    }
}
```

**å­—é¢é‡çš„é‡è¦æ„ä¹‰ï¼š**
 - **æ€§èƒ½ä¼˜åŒ–**ï¼šå­—é¢é‡å¯ä»¥åœ¨ç¼–è¯‘æ—¶ä¼˜åŒ–ï¼Œå‡å°‘è¿è¡Œæ—¶è®¡ç®—
 - **å†…å­˜ç®¡ç†**ï¼šå­—ç¬¦ä¸²å­—é¢é‡çš„é©»ç•™æœºåˆ¶èŠ‚çœå†…å­˜ç©ºé—´
 - **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘å™¨å¯ä»¥åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥å­—é¢é‡çš„ç±»å‹æ­£ç¡®æ€§
 - **ä»£ç å¯è¯»æ€§**ï¼šå­—é¢é‡ä½¿ä»£ç æ›´ç›´è§‚ï¼Œæ˜“äºç†è§£

**ç»å…¸æ¡ˆä¾‹ï¼šå­—ç¬¦ä¸²å­˜å‚¨å’Œå¯¹æ¯”æ·±åº¦è§£æ**

å­—ç¬¦ä¸²åœ¨Javaä¸­çš„å­˜å‚¨æœºåˆ¶æ˜¯é¢è¯•å’Œå®é™…å¼€å‘ä¸­çš„ç»å…¸è¯é¢˜ï¼Œæ¶‰åŠå­—ç¬¦ä¸²å¸¸é‡æ± ã€å †å†…å­˜ã€ä»¥åŠå„ç§åˆ›å»ºæ–¹å¼çš„å†…å­˜åˆ†é…ã€‚

```java
public class StringStorageComparisonDemo {
    public static void main(String[] args) {
        // === ç¬¬ä¸€ç»„ï¼šå­—ç¬¦ä¸²å­—é¢é‡ ===
        String s1 = "Hello";           // å­—é¢é‡ï¼Œå­˜å‚¨åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± 
        String s2 = "Hello";           // åŒä¸€ä¸ªå­—é¢é‡ï¼ŒæŒ‡å‘å¸¸é‡æ± ä¸­åŒä¸€ä¸ªå¯¹è±¡
        String s3 = "Hel" + "lo";      // ç¼–è¯‘æ—¶ä¼˜åŒ–ï¼Œç­‰åŒäº"Hello"å­—é¢é‡
        
        System.out.println("=== å­—ç¬¦ä¸²å­—é¢é‡å¯¹æ¯” ===");
        System.out.println("s1 == s2: " + (s1 == s2));           // true
        System.out.println("s1 == s3: " + (s1 == s3));           // true
        System.out.println("s1.equals(s2): " + s1.equals(s2));   // true
        
        // === ç¬¬äºŒç»„ï¼šnew String() ===
        String s4 = new String("Hello");     // åœ¨å †ä¸­åˆ›å»ºæ–°å¯¹è±¡
        String s5 = new String("Hello");     // åœ¨å †ä¸­åˆ›å»ºå¦ä¸€ä¸ªæ–°å¯¹è±¡
        
        System.out.println("\n=== new String()å¯¹æ¯” ===");
        System.out.println("s1 == s4: " + (s1 == s4));           // falseï¼Œä¸åŒå†…å­˜åŒºåŸŸ
        System.out.println("s4 == s5: " + (s4 == s5));           // falseï¼Œä¸åŒå¯¹è±¡
        System.out.println("s1.equals(s4): " + s1.equals(s4));   // trueï¼Œå†…å®¹ç›¸åŒ
        
        // === ç¬¬ä¸‰ç»„ï¼šè¿è¡Œæ—¶å­—ç¬¦ä¸²æ‹¼æ¥ ===
        String prefix = "Hel";
        String suffix = "lo";
        String s6 = prefix + suffix;          // è¿è¡Œæ—¶æ‹¼æ¥ï¼Œåœ¨å †ä¸­åˆ›å»ºæ–°å¯¹è±¡
        
        System.out.println("\n=== è¿è¡Œæ—¶æ‹¼æ¥å¯¹æ¯” ===");
        System.out.println("s1 == s6: " + (s1 == s6));           // false
        System.out.println("s1.equals(s6): " + s1.equals(s6));   // true
        
        // === ç¬¬å››ç»„ï¼šintern()æ–¹æ³• ===
        String s7 = s6.intern();              // å°†s6çš„å€¼æ”¾å…¥å¸¸é‡æ± ï¼Œè¿”å›å¸¸é‡æ± å¼•ç”¨
        String s8 = new String("Hello").intern(); // è¿”å›å¸¸é‡æ± ä¸­çš„å¼•ç”¨
        
        System.out.println("\n=== intern()æ–¹æ³•å¯¹æ¯” ===");
        System.out.println("s1 == s7: " + (s1 == s7));           // true
        System.out.println("s1 == s8: " + (s1 == s8));           // true
        System.out.println("s7 == s8: " + (s7 == s8));           // true
        
        // === ç¬¬äº”ç»„ï¼šStringBuilder ===
        StringBuilder sb = new StringBuilder();
        sb.append("Hel").append("lo");
        String s9 = sb.toString();            // åˆ›å»ºæ–°çš„Stringå¯¹è±¡
        String s10 = s9.intern();             // è·å–å¸¸é‡æ± å¼•ç”¨
        
        System.out.println("\n=== StringBuilderå¯¹æ¯” ===");
        System.out.println("s1 == s9: " + (s1 == s9));           // false
        System.out.println("s1 == s10: " + (s1 == s10));         // true
        
        // === å†…å­˜åˆ†ææ¼”ç¤º ===
        demonstrateMemoryAllocation();
    }
    
    private static void demonstrateMemoryAllocation() {
        System.out.println("\n=== å†…å­˜åˆ†é…åˆ†æ ===");
        
        // 1. å­—é¢é‡ - å¸¸é‡æ± 
        String literal1 = "Java";
        String literal2 = "Java";
        System.out.println("å­—é¢é‡å†…å­˜åœ°å€ç›¸åŒ: " + (literal1 == literal2));
        
        // 2. new String - å †å†…å­˜
        String heap1 = new String("Java");
        String heap2 = new String("Java");
        System.out.println("å †å¯¹è±¡å†…å­˜åœ°å€ä¸åŒ: " + (heap1 != heap2));
        
        // 3. ç¼–è¯‘æ—¶å¸¸é‡æŠ˜å 
        final String CONST = "Ja";
        String s1 = CONST + "va";              // ç¼–è¯‘æ—¶ä¼˜åŒ–
        String s2 = "Java";
        System.out.println("ç¼–è¯‘æ—¶å¸¸é‡æŠ˜å : " + (s1 == s2));  // true
        
        // 4. è¿è¡Œæ—¶æ‹¼æ¥
        String var = "Ja";
        String s3 = var + "va";                // è¿è¡Œæ—¶æ‹¼æ¥
        System.out.println("è¿è¡Œæ—¶æ‹¼æ¥: " + (s2 == s3));      // false
        
        // 5. intern()çš„å¨åŠ›
        String s4 = s3.intern();
        System.out.println("intern()å: " + (s2 == s4));      // true
    }
}
```

**å†…å­˜åˆ†é…è¯¦ç»†è§£æï¼š**

1. **å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆString Poolï¼‰**ï¼š
   - ä½ç½®ï¼šåœ¨æ–¹æ³•åŒºï¼ˆJDK8+ä¸ºå…ƒç©ºé—´ï¼‰
   - ç‰¹ç‚¹ï¼šå­˜å‚¨å­—ç¬¦ä¸²å­—é¢é‡ï¼Œè‡ªåŠ¨å»é‡
   - è®¿é—®ï¼šé€šè¿‡å­—ç¬¦ä¸²å­—é¢é‡æˆ–intern()æ–¹æ³•

2. **å †å†…å­˜ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡**ï¼š
   - ä½ç½®ï¼šJavaå †
   - ç‰¹ç‚¹ï¼šæ¯æ¬¡new String()éƒ½åˆ›å»ºæ–°å¯¹è±¡
   - è®¿é—®ï¼šé€šè¿‡newæ“ä½œç¬¦æˆ–å­—ç¬¦ä¸²è¿ç®—

3. **ç¼–è¯‘æ—¶ä¼˜åŒ–**ï¼š
   ```java
   // ä»¥ä¸‹ä»£ç åœ¨ç¼–è¯‘æ—¶ä¼šè¢«ä¼˜åŒ–ä¸ºåŒä¸€ä¸ªå­—é¢é‡
   String s1 = "Hello" + "World";        // ç¼–è¯‘æ—¶æ‹¼æ¥
   String s2 = "HelloWorld";             // å­—é¢é‡
   // s1 == s2 ä¸º true
   ```

4. **è¿è¡Œæ—¶å­—ç¬¦ä¸²æ“ä½œ**ï¼š
   ```java
   String base = "Hello";
   String s1 = base + "World";           // è¿è¡Œæ—¶æ‹¼æ¥ï¼Œåˆ›å»ºæ–°å¯¹è±¡
   String s2 = "HelloWorld";             // å­—é¢é‡ï¼Œå¸¸é‡æ± 
   // s1 == s2 ä¸º false
   // s1.intern() == s2 ä¸º true
   ```

**æ€§èƒ½å¯¹æ¯”åˆ†æï¼š**

```java
public class StringPerformanceDemo {
    public static void main(String[] args) {
        int iterations = 100000;
        
        // 1. å­—ç¬¦ä¸²å­—é¢é‡æ€§èƒ½æµ‹è¯•
        long start1 = System.nanoTime();
        for (int i = 0; i < iterations; i++) {
            String s = "Hello World";  // å¸¸é‡æ± ï¼Œæ€§èƒ½æœ€ä½³
        }
        long time1 = System.nanoTime() - start1;
        
        // 2. new String()æ€§èƒ½æµ‹è¯•
        long start2 = System.nanoTime();
        for (int i = 0; i < iterations; i++) {
            String s = new String("Hello World");  // å †åˆ†é…ï¼Œæ€§èƒ½è¾ƒå·®
        }
        long time2 = System.nanoTime() - start2;
        
        // 3. StringBuilderæ€§èƒ½æµ‹è¯•
        long start3 = System.nanoTime();
        for (int i = 0; i < iterations; i++) {
            StringBuilder sb = new StringBuilder();
            sb.append("Hello").append(" ").append("World");
            String s = sb.toString();
        }
        long time3 = System.nanoTime() - start3;
        
        System.out.println("å­—é¢é‡è€—æ—¶: " + time1 + " ns");
        System.out.println("new Stringè€—æ—¶: " + time2 + " ns");
        System.out.println("StringBuilderè€—æ—¶: " + time3 + " ns");
        System.out.println("new Stringæ˜¯å­—é¢é‡çš„ " + (time2/time1) + " å€");
    }
}
```

**å…³é”®è¦ç‚¹æ€»ç»“ï¼š**

1. **== vs equals()**ï¼š
   - `==`æ¯”è¾ƒå¼•ç”¨åœ°å€ï¼ˆå†…å­˜ä½ç½®ï¼‰
   - `equals()`æ¯”è¾ƒå­—ç¬¦ä¸²å†…å®¹

2. **å­—ç¬¦ä¸²åˆ›å»ºæ–¹å¼çš„å†…å­˜å½±å“**ï¼š
   - å­—é¢é‡ï¼šå¸¸é‡æ± ï¼Œå†…å­˜å…±äº«
   - new String()ï¼šå †å†…å­˜ï¼Œç‹¬ç«‹å¯¹è±¡
   - è¿è¡Œæ—¶æ‹¼æ¥ï¼šå †å†…å­˜ï¼Œæ–°å¯¹è±¡
   - intern()ï¼šè¿”å›å¸¸é‡æ± å¼•ç”¨

3. **æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
   - ä¼˜å…ˆä½¿ç”¨å­—ç¬¦ä¸²å­—é¢é‡
   - é¿å…ä¸å¿…è¦çš„new String()
   - å¤§é‡å­—ç¬¦ä¸²æ‹¼æ¥ä½¿ç”¨StringBuilder
   - åˆç†ä½¿ç”¨intern()æ–¹æ³•

4. **å†…å­˜æ³„æ¼é£é™©**ï¼š
    - è¿‡åº¦ä½¿ç”¨intern()å¯èƒ½å¯¼è‡´å¸¸é‡æ± å†…å­˜æ³„æ¼
    - å¤§é‡å­—ç¬¦ä¸²å¯¹è±¡å¯èƒ½å¯¼è‡´å †å†…å­˜å‹åŠ›

**å¼•ç”¨å­˜å‚¨ä½ç½®è¯¦è§£**

åœ¨è®¨è®ºå­—ç¬¦ä¸²å­˜å‚¨ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼š**å¼•ç”¨çš„å­˜å‚¨ä½ç½®å–å†³äºå¼•ç”¨å˜é‡çš„å£°æ˜ä½ç½®**ã€‚

```java
public class ReferenceLocationDemo {
    // ç±»å˜é‡ï¼ˆé™æ€å˜é‡ï¼‰çš„å¼•ç”¨å­˜å‚¨åœ¨æ–¹æ³•åŒº
    private static String staticRef = "Hello";
    
    // å®ä¾‹å˜é‡çš„å¼•ç”¨å­˜å‚¨åœ¨å †å†…å­˜ï¼ˆå¯¹è±¡å†…éƒ¨ï¼‰
    private String instanceRef = "World";
    
    public void method() {
        // å±€éƒ¨å˜é‡çš„å¼•ç”¨å­˜å‚¨åœ¨è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§çš„å±€éƒ¨å˜é‡è¡¨ï¼‰
        String localRef = "Local";
        
        // æ–¹æ³•å‚æ•°çš„å¼•ç”¨ä¹Ÿå­˜å‚¨åœ¨è™šæ‹Ÿæœºæ ˆ
        processString("Parameter");
    }
    
    private void processString(String paramRef) {
        // paramRefå¼•ç”¨å­˜å‚¨åœ¨å½“å‰æ ˆå¸§çš„å±€éƒ¨å˜é‡è¡¨ä¸­
        System.out.println(paramRef);
    }
}
```

**å¼•ç”¨å­˜å‚¨è§„å¾‹æ€»ç»“ï¼š**
- **é™æ€å˜é‡å¼•ç”¨** â†’ æ–¹æ³•åŒº
- **å®ä¾‹å˜é‡å¼•ç”¨** â†’ å †å†…å­˜ï¼ˆå¯¹è±¡å†…éƒ¨ï¼‰
- **å±€éƒ¨å˜é‡å¼•ç”¨** â†’ è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ï¼‰
- **æ–¹æ³•å‚æ•°å¼•ç”¨** â†’ è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ï¼‰

**ğŸµ JVMå†…å­˜å­˜å‚¨é¡ºå£æºœ ğŸµ**

ä¸ºäº†å¸®åŠ©å¤§å®¶è®°å¿†JVMå†…å­˜ä¸­å­—ç¬¦ä¸²å’Œå¼•ç”¨çš„å­˜å‚¨ä½ç½®ï¼Œç‰¹åˆ«åˆ›ä½œä»¥ä¸‹é¡ºå£æºœï¼š

```
ğŸ“ ã€JVMå†…å­˜å­˜å‚¨é¡ºå£æºœã€‘

å­—é¢é‡å¸¸é‡æ± é‡Œè—ï¼Œ
å †ä¸­å¯¹è±¡å„è‡ªå¿™ã€‚
å¼•ç”¨ä½ç½®çœ‹å£°æ˜ï¼Œ
é™æ€æ–¹æ³•åŒºé‡Œæ”¾ã€‚

å®ä¾‹å¼•ç”¨å †ä¸­å­˜ï¼Œ
å±€éƒ¨æ ˆå¸§æ¥å¸®å¿™ã€‚
internä¸€è°ƒå›è€å®¶ï¼Œ
å¸¸é‡æ± é‡Œå…±åˆ†äº«ã€‚

newå‡ºå¯¹è±¡å †é‡Œä½ï¼Œ
å­—é¢é‡ä»¬æ± ä¸­èšã€‚
== æ¯”åœ°å€è¦è®°æ¸…ï¼Œ
equalså†…å®¹æ¥å¯¹æ¯”ã€‚
```

**ğŸ¤ JVMå†…å­˜é¥¶èˆŒç‰ˆ ğŸ¤**

```
ğŸµ ã€JVM Memory Rapã€‘

Yo! å¬æˆ‘è¯´JVMçš„å†…å­˜åˆ†é…ï¼Œ
å­—ç¬¦ä¸²å­˜å‚¨æœ‰é—¨é“ï¼Œåˆ«ææ··æ·†ï¼

å­—é¢é‡literalä½å¸¸é‡æ± ï¼ŒString Poolæ˜¯å®ƒçš„æ ¹æ®åœ°ï¼Œ
"Hello World"è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œç¼–è¯‘æ—¶å°±å®šå¥½äº†ä½ç½®ï¼

new String()å †é‡Œé€ ï¼Œæ¯æ¬¡è°ƒç”¨æ–°å¯¹è±¡ï¼Œ
å†…å­˜åœ°å€ä¸ç›¸åŒï¼Œ== æ¯”è¾ƒå°±æ˜¯falseï¼

å¼•ç”¨å˜é‡çœ‹ä½ç½®ï¼š
- staticé™æ€æ–¹æ³•åŒºï¼Œ
- instanceå®ä¾‹å †ä¸­å­˜ï¼Œ
- localå±€éƒ¨æ ˆå¸§é‡Œï¼Œ
- parameterå‚æ•°ä¹Ÿåœ¨æ ˆï¼

intern()æ–¹æ³•æ˜¯ç¥å™¨ï¼Œ
æŠŠå †ä¸­å­—ç¬¦ä¸²é€å›æ± ï¼Œ
å¸¸é‡æ± é‡Œæ¥å›¢èšï¼Œ
å†…å­˜å…±äº«æ•ˆç‡é«˜ï¼

è®°ä½å£è¯€åˆ«å¿˜è®°ï¼š
å­—é¢é‡æ± ï¼Œå¯¹è±¡å †ï¼Œ
å¼•ç”¨ä½ç½®çœ‹å£°æ˜ï¼Œ
JVMå†…å­˜è¦åˆ†æ¸…ï¼

Yeah! JVM Memory Rapå®Œæ¯•ï¼
```

**ğŸ§  è®°å¿†æŠ€å·§**

1. **å­—é¢é‡ = å¸¸é‡æ± **ï¼šæƒ³è±¡å­—é¢é‡æ˜¯"å¸¸å®¢"ï¼Œä½åœ¨"å¸¸é‡æ± é…’åº—"
2. **newå¯¹è±¡ = å †å†…å­˜**ï¼šæƒ³è±¡newæ˜¯"æ–°å»ºæˆ¿å­"ï¼Œéƒ½å»ºåœ¨"å †ç§¯å¦‚å±±"çš„åœ°æ–¹
3. **å¼•ç”¨çœ‹å£°æ˜**ï¼šå¼•ç”¨å°±åƒ"é—¨ç‰Œå·"ï¼Œé—¨ç‰Œå·æ”¾åœ¨å“ªé‡Œå–å†³äºæˆ¿å­å»ºåœ¨å“ªé‡Œ
4. **intern = å›è€å®¶**ï¼šæƒ³è±¡internæ˜¯"å›è€å®¶"ï¼ŒæŠŠåœ¨å¤–æ¼‚æ³Šçš„å­—ç¬¦ä¸²é€å›å¸¸é‡æ± è€å®¶

**ğŸ“Š å†…å­˜åˆ†å¸ƒç¤ºæ„å›¾ï¼ˆé¡ºå£æºœç‰ˆï¼‰**

```
æ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ  é™æ€å˜é‡å¼•ç”¨ä½è¿™é‡Œ            â”‚
â”‚  ğŸ“š å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆå­—é¢é‡çš„å®¶ï¼‰     â”‚
â”‚  ğŸ¯ ç±»ä¿¡æ¯ã€æ–¹æ³•ä¿¡æ¯              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å †å†…å­˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ—ï¸  new String()å¯¹è±¡ä½è¿™é‡Œ      â”‚
â”‚  ğŸ˜ï¸  å®ä¾‹å˜é‡å¼•ç”¨åœ¨å¯¹è±¡å†…éƒ¨        â”‚
â”‚  ğŸ“¦ æ‰€æœ‰å¯¹è±¡å®ä¾‹                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è™šæ‹Ÿæœºæ ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ å±€éƒ¨å˜é‡å¼•ç”¨ä½æ ˆå¸§é‡Œ          â”‚
â”‚  ğŸ“ æ–¹æ³•å‚æ•°å¼•ç”¨ä¹Ÿåœ¨è¿™é‡Œ          â”‚
â”‚  ğŸ”„ æ–¹æ³•è°ƒç”¨ä¿¡æ¯                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å†…å­˜åˆ†é…ç¤ºæ„å›¾ï¼š**
```
æ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰:
â”œâ”€â”€ classVariableå¼•ç”¨ â†’ æŒ‡å‘å †ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡
â”œâ”€â”€ ç±»çš„å…ƒæ•°æ®ä¿¡æ¯
â””â”€â”€ è¿è¡Œæ—¶å¸¸é‡æ± 
    â””â”€â”€ "å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²"å¯¹è±¡

å †å†…å­˜:
â”œâ”€â”€ MemoryAreaDemoå¯¹è±¡å®ä¾‹
â”‚   â””â”€â”€ instanceVariableå¼•ç”¨ â†’ æŒ‡å‘å †ä¸­çš„å¦ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡
â”œâ”€â”€ "å­˜å‚¨åœ¨æ–¹æ³•åŒº"å­—ç¬¦ä¸²å¯¹è±¡
â”œâ”€â”€ "å­˜å‚¨åœ¨å †ä¸­"å­—ç¬¦ä¸²å¯¹è±¡
â””â”€â”€ "æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡"å­—ç¬¦ä¸²å¯¹è±¡

è™šæ‹Ÿæœºæ ˆ:
â”œâ”€â”€ mainæ–¹æ³•æ ˆå¸§
â”‚   â”œâ”€â”€ localVariable = 42ï¼ˆç›´æ¥å­˜å‚¨å€¼ï¼‰
â”‚   â””â”€â”€ demoå¼•ç”¨ â†’ æŒ‡å‘å †ä¸­çš„MemoryAreaDemoå¯¹è±¡
â””â”€â”€ demonstrateStackFrameæ–¹æ³•æ ˆå¸§
    â”œâ”€â”€ parameter = 42ï¼ˆç›´æ¥å­˜å‚¨å€¼ï¼‰
    â”œâ”€â”€ localStringå¼•ç”¨ â†’ æŒ‡å‘å †ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡
    â””â”€â”€ literalå¼•ç”¨ â†’ æŒ‡å‘å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡
```

**æ ¸å¿ƒè¦ç‚¹æ€»ç»“ï¼š**
- **å¼•ç”¨**å’Œ**å¯¹è±¡**æ˜¯åˆ†å¼€å­˜å‚¨çš„
- é™æ€å˜é‡çš„å¼•ç”¨åœ¨æ–¹æ³•åŒºï¼Œä½†å¯¹è±¡ä»åœ¨å †ä¸­
- åŸºæœ¬ç±»å‹å±€éƒ¨å˜é‡ç›´æ¥å­˜å‚¨å€¼ï¼Œå¼•ç”¨ç±»å‹å­˜å‚¨æŒ‡é’ˆ
- å­—ç¬¦ä¸²å­—é¢é‡æœ‰ç‰¹æ®Šçš„å¸¸é‡æ± æœºåˆ¶
- ç†è§£è¿™ä¸ªåŒºåˆ«å¯¹äºJVMè°ƒä¼˜å’Œå†…å­˜åˆ†æè‡³å…³é‡è¦

## ç¬¬ä¸€éƒ¨åˆ†ï¼šç¨‹åºè®¡æ•°å™¨(PC Register)æ·±åº¦è§£æ

### 1.1 PC Registerçš„è®¾è®¡åŸç†

æ ¹æ®JVMè§„èŒƒï¼Œç¨‹åºè®¡æ•°å™¨æ˜¯JVMä¸­æœ€å°çš„å†…å­˜åŒºåŸŸï¼Œç”¨äºå­˜å‚¨å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ã€‚

**OpenJDKæºç åˆ†æï¼š**

åœ¨OpenJDKçš„`hotspot/src/share/vm/runtime/thread.hpp`ä¸­ï¼ŒPC Registerçš„å®šä¹‰ï¼š

```cpp
// OpenJDKæºç ç‰‡æ®µ
class JavaThread: public Thread {
private:
  // Program counter for current instruction being executed
  address _pc;
  
  // Last Java frame anchor
  JavaFrameAnchor _anchor;
  
public:
  address pc() const { return _pc; }
  void set_pc(address pc) { _pc = pc; }
};
```

### 1.2 PC Registerçš„å·¥ä½œæœºåˆ¶

```java
// PCRegisterDemo.java - æ¼”ç¤ºPC Registerçš„å·¥ä½œ
public class PCRegisterDemo {
    public static void main(String[] args) {
        int a = 1;          // PCæŒ‡å‘è¿™æ¡æŒ‡ä»¤çš„å­—èŠ‚ç åœ°å€
        int b = 2;          // PCç§»åŠ¨åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤
        int c = a + b;      // PCç»§ç»­ç§»åŠ¨
        
        if (c > 2) {        // æ¡ä»¶è·³è½¬æŒ‡ä»¤ï¼ŒPCå¯èƒ½è·³è½¬
            System.out.println("c > 2");
        }
        
        // æ–¹æ³•è°ƒç”¨æ—¶ï¼ŒPCä¿å­˜è¿”å›åœ°å€
        methodCall();
        
        System.out.println("æ–¹æ³•è°ƒç”¨è¿”å›åç»§ç»­æ‰§è¡Œ");
    }
    
    private static void methodCall() {
        // æ–°çº¿ç¨‹æœ‰ç‹¬ç«‹çš„PC Register
        Thread thread = new Thread(() -> {
            System.out.println("æ–°çº¿ç¨‹çš„PC Registerç‹¬ç«‹å·¥ä½œ");
        });
        thread.start();
    }
}
```

**å­—èŠ‚ç åˆ†æï¼š**

```bash
# æŸ¥çœ‹å­—èŠ‚ç æŒ‡ä»¤å’ŒPC Registerçš„å˜åŒ–
javac PCRegisterDemo.java
javap -c PCRegisterDemo
```

è¾“å‡ºç»“æœæ˜¾ç¤ºæ¯æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åç§»åœ°å€ï¼Œè¿™å°±æ˜¯PC Registerä¸­å­˜å‚¨çš„å€¼ï¼š

```
public static void main(java.lang.String[]);
  Code:
     0: iconst_1          // PC = 0
     1: istore_1          // PC = 1
     2: iconst_2          // PC = 2
     3: istore_2          // PC = 3
     4: iload_1           // PC = 4
     5: iload_2           // PC = 5
     6: iadd              // PC = 6
     7: istore_3          // PC = 7
     8: iload_3           // PC = 8
     9: iconst_2          // PC = 9
    10: if_icmple     19  // PC = 10, æ¡ä»¶è·³è½¬
    13: getstatic     #2  // PC = 13
    16: ldc           #3  // PC = 16
    18: invokevirtual #4  // PC = 18
    19: invokestatic  #5  // PC = 19
    22: getstatic     #2  // PC = 22
    25: ldc           #6  // PC = 25
    27: invokevirtual #4  // PC = 27
    30: return           // PC = 30
```

### 1.3 PC Registerçš„ç‰¹æ®Šæƒ…å†µ

```java
// NativeMethodDemo.java - æ¼”ç¤ºæœ¬åœ°æ–¹æ³•å¯¹PC Registerçš„å½±å“
public class NativeMethodDemo {
    public static void main(String[] args) {
        // Javaæ–¹æ³•è°ƒç”¨ - PC Registeræ­£å¸¸å·¥ä½œ
        javaMethod();
        
        // æœ¬åœ°æ–¹æ³•è°ƒç”¨ - PC Registerå€¼ä¸ºundefined
        System.currentTimeMillis(); // è¿™æ˜¯ä¸€ä¸ªnativeæ–¹æ³•
        
        // è¿”å›Javaæ–¹æ³•å - PC Registeræ¢å¤æ­£å¸¸
        System.out.println("è¿”å›Javaæ–¹æ³•");
    }
    
    private static void javaMethod() {
        System.out.println("Javaæ–¹æ³•ä¸­PC Registeræ­£å¸¸å·¥ä½œ");
    }
}
```

**å…³é”®ç‰¹æ€§ï¼š**
1. **çº¿ç¨‹ç§æœ‰**ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„PC Register
2. **æ— OutOfMemoryError**ï¼šPC Registerä¸ä¼šå‘ç”Ÿå†…å­˜æº¢å‡º
3. **æœ¬åœ°æ–¹æ³•ç‰¹æ®Šå¤„ç†**ï¼šæ‰§è¡Œæœ¬åœ°æ–¹æ³•æ—¶ï¼ŒPC Registerå€¼ä¸ºundefined

## ç¬¬äºŒéƒ¨åˆ†ï¼šJavaè™šæ‹Ÿæœºæ ˆ(JVM Stack)æ·±åº¦è§£æ

### 2.1 è™šæ‹Ÿæœºæ ˆçš„è®¾è®¡åŸç†

æ ¹æ®JVMè§„èŒƒï¼ŒJavaè™šæ‹Ÿæœºæ ˆæè¿°çš„æ˜¯Javaæ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ï¼šæ¯ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ã€‚

**OpenJDKæºç åˆ†æï¼š**

åœ¨`hotspot/src/share/vm/runtime/frame.hpp`ä¸­å®šä¹‰äº†æ ˆå¸§ç»“æ„ï¼š

```cpp
// OpenJDKæºç ç‰‡æ®µ
class frame {
private:
  intptr_t* _sp; // stack pointer
  address   _pc; // program counter
  
  // Frame layout:
  // [locals and parameters]
  // [operand stack]
  // [frame data]
  
public:
  // Accessors for locals
  oop obj_at(int offset) const;
  jint int_at(int offset) const;
  
  // Operand stack manipulation
  void push_int(jint value);
  jint pop_int();
};
```

#### è™šæ‹Ÿæœºæ ˆå·¥ä½œåŸç†å®æˆ˜æ¼”ç¤º

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„Javaæ–¹æ³•æ¥è§‚å¯Ÿè™šæ‹Ÿæœºæ ˆçš„å®é™…å·¥ä½œè¿‡ç¨‹ï¼š

```java
// VirtualMachineStackDemo.java
public class VirtualMachineStackDemo {
    public static void main(String[] args) {
        int result = addNumbers(10, 20);
        System.out.println("Result: " + result);
    }
    
    public static int addNumbers(int a, int b) {
        int sum = a + b;
        return sum;
    }
}
```

**å¯¹åº”çš„å­—èŠ‚ç åç¼–è¯‘ç»“æœï¼š**

```bash
# ä½¿ç”¨ javap -c -v VirtualMachineStackDemo å‘½ä»¤è·å¾—

public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=3, locals=2, args_size=1
         0: bipush        10           // å°†å¸¸é‡10å‹å…¥æ“ä½œæ•°æ ˆ
         2: bipush        20           // å°†å¸¸é‡20å‹å…¥æ“ä½œæ•°æ ˆ
         4: invokestatic  #2           // è°ƒç”¨addNumbersæ–¹æ³•
         7: istore_1                   // å°†è¿”å›å€¼å­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨ç´¢å¼•1(result)
         8: getstatic     #3           // è·å–System.outå­—æ®µ
        11: new           #4           // åˆ›å»ºStringBuilderå¯¹è±¡
        14: dup                        // å¤åˆ¶æ ˆé¡¶å¼•ç”¨
        15: invokespecial #5           // è°ƒç”¨StringBuilderæ„é€ æ–¹æ³•
        18: ldc           #6           // åŠ è½½å­—ç¬¦ä¸²å¸¸é‡"Result: "
        20: invokevirtual #7           // è°ƒç”¨appendæ–¹æ³•
        23: iload_1                    // åŠ è½½resultå˜é‡
        24: invokevirtual #8           // è°ƒç”¨append(int)æ–¹æ³•
        27: invokevirtual #9           // è°ƒç”¨toStringæ–¹æ³•
        30: invokevirtual #10          // è°ƒç”¨printlnæ–¹æ³•
        33: return                     // æ–¹æ³•è¿”å›
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      34     0  args   [Ljava/lang/String;
            8      26     1 result   I
      LineNumberTable:
        line 3: 0
        line 4: 8
        line 5: 33

public static int addNumbers(int, int);
    descriptor: (II)I
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=3, args_size=2
         0: iload_0                    // å°†å‚æ•°aå‹å…¥æ“ä½œæ•°æ ˆ
         1: iload_1                    // å°†å‚æ•°bå‹å…¥æ“ä½œæ•°æ ˆ
         2: iadd                       // æ‰§è¡ŒåŠ æ³•è¿ç®—ï¼Œç»“æœå‹å…¥æ ˆé¡¶
         3: istore_2                   // å°†ç»“æœå­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨ç´¢å¼•2(sum)
         4: iload_2                    // å°†sumå‹å…¥æ“ä½œæ•°æ ˆ
         5: ireturn                    // è¿”å›æ ˆé¡¶çš„intå€¼
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       6     0     a   I
            0       6     1     b   I
            4       2     2   sum   I
      LineNumberTable:
        line 7: 0
        line 8: 4
```

**æ ˆå¸§è¯¦ç»†åˆ†æï¼š**

1. **mainæ–¹æ³•æ ˆå¸§ï¼š**
   - `stack=3`ï¼šæ“ä½œæ•°æ ˆæœ€å¤§æ·±åº¦ä¸º3
   - `locals=2`ï¼šå±€éƒ¨å˜é‡è¡¨å¤§å°ä¸º2ï¼ˆargs + resultï¼‰
   - `args_size=1`ï¼šæ–¹æ³•å‚æ•°ä¸ªæ•°ä¸º1ï¼ˆargsæ•°ç»„ï¼‰

2. **addNumbersæ–¹æ³•æ ˆå¸§ï¼š**
   - `stack=2`ï¼šæ“ä½œæ•°æ ˆæœ€å¤§æ·±åº¦ä¸º2
   - `locals=3`ï¼šå±€éƒ¨å˜é‡è¡¨å¤§å°ä¸º3ï¼ˆa + b + sumï¼‰
   - `args_size=2`ï¼šæ–¹æ³•å‚æ•°ä¸ªæ•°ä¸º2ï¼ˆaå’Œbï¼‰

**æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ ˆå¸§å˜åŒ–ï¼š**

```
æ‰§è¡Œé˜¶æ®µ1ï¼šmainæ–¹æ³•å¼€å§‹æ‰§è¡Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mainæ–¹æ³•æ ˆå¸§                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ å±€éƒ¨å˜é‡è¡¨                    â”‚   â”‚
â”‚ â”‚ [0] args: String[]          â”‚   â”‚
â”‚ â”‚ [1] result: (æœªåˆå§‹åŒ–)        â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æ“ä½œæ•°æ ˆ                      â”‚   â”‚
â”‚ â”‚ (ç©º)                        â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œé˜¶æ®µ2ï¼šå‡†å¤‡è°ƒç”¨addNumbersæ–¹æ³•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mainæ–¹æ³•æ ˆå¸§                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æ“ä½œæ•°æ ˆ                      â”‚   â”‚
â”‚ â”‚ [æ ˆé¡¶] 20                   â”‚   â”‚
â”‚ â”‚        10                   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œé˜¶æ®µ3ï¼šaddNumbersæ–¹æ³•æ‰§è¡Œä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ addNumbersæ–¹æ³•æ ˆå¸§                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ å±€éƒ¨å˜é‡è¡¨                    â”‚   â”‚
â”‚ â”‚ [0] a: 10                   â”‚   â”‚
â”‚ â”‚ [1] b: 20                   â”‚   â”‚
â”‚ â”‚ [2] sum: 30                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æ“ä½œæ•°æ ˆ                      â”‚   â”‚
â”‚ â”‚ [æ ˆé¡¶] 30 (å‡†å¤‡è¿”å›)          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mainæ–¹æ³•æ ˆå¸§ (ç­‰å¾…ä¸­)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œé˜¶æ®µ4ï¼šaddNumbersæ–¹æ³•è¿”å›å
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mainæ–¹æ³•æ ˆå¸§                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ å±€éƒ¨å˜é‡è¡¨                    â”‚   â”‚
â”‚ â”‚ [0] args: String[]          â”‚   â”‚
â”‚ â”‚ [1] result: 30              â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æ“ä½œæ•°æ ˆ                      â”‚   â”‚
â”‚ â”‚ (ç»§ç»­æ‰§è¡Œprintln...)          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ˆå¸§ç»“æ„è¯¦è§£

```java
// StackFrameDemo.java - æ¼”ç¤ºæ ˆå¸§çš„è¯¦ç»†ç»“æ„
public class StackFrameDemo {
    private static int staticVar = 100;
    
    public static void main(String[] args) {
        System.out.println("=== æ ˆå¸§ç»“æ„æ¼”ç¤º ===\n");
        
        // mainæ–¹æ³•çš„æ ˆå¸§åŒ…å«ï¼š
        // - å±€éƒ¨å˜é‡è¡¨ï¼šargs
        // - æ“ä½œæ•°æ ˆï¼šç”¨äºè®¡ç®—å’Œæ–¹æ³•è°ƒç”¨
        // - åŠ¨æ€é“¾æ¥ï¼šæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± 
        // - æ–¹æ³•è¿”å›åœ°å€ï¼šç¨‹åºç»“æŸåœ°å€
        
        int localVar1 = 10;
        String localVar2 = "Hello";
        
        System.out.println("è°ƒç”¨level1æ–¹æ³•å‰çš„æ ˆçŠ¶æ€ï¼š");
        System.out.println("å½“å‰æ ˆæ·±åº¦ï¼š1 (mainæ–¹æ³•)");
        
        level1(localVar1, localVar2);
        
        System.out.println("\nlevel1æ–¹æ³•è¿”å›åï¼Œæ ˆæ¢å¤åˆ°mainæ–¹æ³•");
    }
    
    private static void level1(int param1, String param2) {
        // level1æ–¹æ³•çš„æ ˆå¸§åŒ…å«ï¼š
        // - å±€éƒ¨å˜é‡è¡¨ï¼šparam1, param2, local1, local2
        // - æ“ä½œæ•°æ ˆï¼šç”¨äºè®¡ç®— param1 + staticVar
        // - åŠ¨æ€é“¾æ¥ï¼šæŒ‡å‘StackFrameDemoçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¿¡æ¯
        // - æ–¹æ³•è¿”å›åœ°å€ï¼šmainæ–¹æ³•ä¸­è°ƒç”¨level1çš„ä¸‹ä¸€æ¡æŒ‡ä»¤
        
        int local1 = param1 + staticVar; // æ“ä½œæ•°æ ˆï¼šparam1, staticVar, iadd
        String local2 = param2 + " World"; // æ“ä½œæ•°æ ˆï¼šparam2, " World", concat
        
        System.out.println("level1æ–¹æ³•ä¸­çš„æ ˆçŠ¶æ€ï¼š");
        System.out.println("å½“å‰æ ˆæ·±åº¦ï¼š2 (main -> level1)");
        System.out.println("å±€éƒ¨å˜é‡è¡¨ï¼šparam1=" + param1 + ", param2=" + param2);
        System.out.println("å±€éƒ¨å˜é‡è¡¨ï¼šlocal1=" + local1 + ", local2=" + local2);
        
        level2(local1);
    }
    
    private static void level2(int param) {
        // level2æ–¹æ³•çš„æ ˆå¸§
        System.out.println("level2æ–¹æ³•ä¸­çš„æ ˆçŠ¶æ€ï¼š");
        System.out.println("å½“å‰æ ˆæ·±åº¦ï¼š3 (main -> level1 -> level2)");
        System.out.println("å±€éƒ¨å˜é‡è¡¨ï¼šparam=" + param);
        
        // æ¼”ç¤ºæ“ä½œæ•°æ ˆçš„ä½¿ç”¨
        int result = calculateSum(param, 20, 30);
        System.out.println("è®¡ç®—ç»“æœï¼š" + result);
    }
    
    private static int calculateSum(int a, int b, int c) {
        // calculateSumæ–¹æ³•çš„æ ˆå¸§
        System.out.println("calculateSumæ–¹æ³•ä¸­çš„æ ˆçŠ¶æ€ï¼š");
        System.out.println("å½“å‰æ ˆæ·±åº¦ï¼š4 (main -> level1 -> level2 -> calculateSum)");
        
        // æ“ä½œæ•°æ ˆçš„è¯¦ç»†ä½¿ç”¨è¿‡ç¨‹ï¼š
        // 1. iload_1 (å°†aå‹å…¥æ“ä½œæ•°æ ˆ)
        // 2. iload_2 (å°†bå‹å…¥æ“ä½œæ•°æ ˆ)
        // 3. iadd    (å¼¹å‡ºä¸¤ä¸ªå€¼ï¼Œç›¸åŠ ï¼Œç»“æœå‹å…¥æ ˆ)
        // 4. iload_3 (å°†cå‹å…¥æ“ä½œæ•°æ ˆ)
        // 5. iadd    (å¼¹å‡ºä¸¤ä¸ªå€¼ï¼Œç›¸åŠ ï¼Œç»“æœå‹å…¥æ ˆ)
        // 6. ireturn (è¿”å›æ ˆé¡¶å€¼)
        
        return a + b + c;
    }
}
```

### 2.3 å±€éƒ¨å˜é‡è¡¨æ·±åº¦åˆ†æ

```java
// LocalVariableTableDemo.java - æ¼”ç¤ºå±€éƒ¨å˜é‡è¡¨çš„å·¥ä½œæœºåˆ¶
public class LocalVariableTableDemo {
    public static void main(String[] args) {
        demonstrateLocalVariableTable();
    }
    
    private static void demonstrateLocalVariableTable() {
        // å±€éƒ¨å˜é‡è¡¨ç´¢å¼•åˆ†é…ï¼š
        // ç´¢å¼•0ï¼šthis (å®ä¾‹æ–¹æ³•) æˆ– ç©º (é™æ€æ–¹æ³•)
        
        boolean boolVar = true;     // ç´¢å¼•0ï¼Œå ç”¨1ä¸ªslot
        byte byteVar = 127;         // ç´¢å¼•1ï¼Œå ç”¨1ä¸ªslot
        short shortVar = 32767;     // ç´¢å¼•2ï¼Œå ç”¨1ä¸ªslot
        int intVar = 2147483647;    // ç´¢å¼•3ï¼Œå ç”¨1ä¸ªslot
        float floatVar = 3.14f;     // ç´¢å¼•4ï¼Œå ç”¨1ä¸ªslot
        
        // longå’Œdoubleå ç”¨2ä¸ªslot
        long longVar = 9223372036854775807L;  // ç´¢å¼•5-6ï¼Œå ç”¨2ä¸ªslot
        double doubleVar = 3.141592653589793;  // ç´¢å¼•7-8ï¼Œå ç”¨2ä¸ªslot
        
        // å¼•ç”¨ç±»å‹å ç”¨1ä¸ªslot
        String stringVar = "Hello";  // ç´¢å¼•9ï¼Œå ç”¨1ä¸ªslot
        Object objVar = new Object(); // ç´¢å¼•10ï¼Œå ç”¨1ä¸ªslot
        
        System.out.println("å±€éƒ¨å˜é‡è¡¨æ¼”ç¤ºï¼š");
        System.out.println("boolean: " + boolVar + " (slot 0)");
        System.out.println("byte: " + byteVar + " (slot 1)");
        System.out.println("short: " + shortVar + " (slot 2)");
        System.out.println("int: " + intVar + " (slot 3)");
        System.out.println("float: " + floatVar + " (slot 4)");
        System.out.println("long: " + longVar + " (slot 5-6)");
        System.out.println("double: " + doubleVar + " (slot 7-8)");
        System.out.println("String: " + stringVar + " (slot 9)");
        System.out.println("Object: " + objVar + " (slot 10)");
        
        // æ¼”ç¤ºslotçš„é‡ç”¨
        demonstrateSlotReuse();
    }
    
    private static void demonstrateSlotReuse() {
        {
            // ä»£ç å—1
            int tempVar1 = 100;  // å‡è®¾ä½¿ç”¨slot 0
            System.out.println("ä»£ç å—1ä¸­çš„tempVar1: " + tempVar1);
        } // tempVar1çš„ä½œç”¨åŸŸç»“æŸ
        
        {
            // ä»£ç å—2
            String tempVar2 = "World";  // å¯èƒ½é‡ç”¨slot 0
            System.out.println("ä»£ç å—2ä¸­çš„tempVar2: " + tempVar2);
        } // tempVar2çš„ä½œç”¨åŸŸç»“æŸ
        
        System.out.println("æ¼”ç¤ºäº†å±€éƒ¨å˜é‡è¡¨slotçš„é‡ç”¨æœºåˆ¶");
    }
}
```

### 2.4 æ“ä½œæ•°æ ˆæ·±åº¦åˆ†æ

```java
// OperandStackDemo.java - æ¼”ç¤ºæ“ä½œæ•°æ ˆçš„å·¥ä½œæœºåˆ¶
public class OperandStackDemo {
    public static void main(String[] args) {
        demonstrateOperandStack();
    }
    
    private static void demonstrateOperandStack() {
        System.out.println("=== æ“ä½œæ•°æ ˆæ¼”ç¤º ===\n");
        
        // ç®€å•ç®—æœ¯è¿ç®—çš„æ“ä½œæ•°æ ˆå˜åŒ–
        int a = 10;
        int b = 20;
        int c = a + b;  // è¿™è¡Œä»£ç çš„æ“ä½œæ•°æ ˆå˜åŒ–è¿‡ç¨‹
        
        /*
         * å­—èŠ‚ç æŒ‡ä»¤åºåˆ—å’Œæ“ä½œæ•°æ ˆå˜åŒ–ï¼š
         * 
         * iload_1      // å°†å±€éƒ¨å˜é‡a(10)å‹å…¥æ“ä½œæ•°æ ˆ
         *              // æ ˆçŠ¶æ€: [10]
         * 
         * iload_2      // å°†å±€éƒ¨å˜é‡b(20)å‹å…¥æ“ä½œæ•°æ ˆ
         *              // æ ˆçŠ¶æ€: [10, 20] (æ ˆé¡¶æ˜¯20)
         * 
         * iadd         // å¼¹å‡ºæ ˆé¡¶ä¸¤ä¸ªå…ƒç´ ï¼Œç›¸åŠ ï¼Œç»“æœå‹å…¥æ ˆ
         *              // æ ˆçŠ¶æ€: [30]
         * 
         * istore_3     // å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå­˜å‚¨åˆ°å±€éƒ¨å˜é‡c
         *              // æ ˆçŠ¶æ€: []
         */
        
        System.out.println("ç®€å•è¿ç®—ç»“æœ: " + c);
        
        // å¤æ‚è¡¨è¾¾å¼çš„æ“ä½œæ•°æ ˆå˜åŒ–
        int result = (a + b) * (a - b);
        
        /*
         * å¤æ‚è¡¨è¾¾å¼çš„æ“ä½œæ•°æ ˆå˜åŒ–ï¼š
         * 
         * iload_1      // å‹å…¥a(10)
         *              // æ ˆ: [10]
         * iload_2      // å‹å…¥b(20)
         *              // æ ˆ: [10, 20]
         * iadd         // è®¡ç®—a+b
         *              // æ ˆ: [30]
         * iload_1      // å‹å…¥a(10)
         *              // æ ˆ: [30, 10]
         * iload_2      // å‹å…¥b(20)
         *              // æ ˆ: [30, 10, 20]
         * isub         // è®¡ç®—a-b
         *              // æ ˆ: [30, -10]
         * imul         // è®¡ç®—(a+b)*(a-b)
         *              // æ ˆ: [-300]
         * istore       // å­˜å‚¨ç»“æœ
         *              // æ ˆ: []
         */
        
        System.out.println("å¤æ‚è¿ç®—ç»“æœ: " + result);
        
        // æ–¹æ³•è°ƒç”¨çš„æ“ä½œæ•°æ ˆå˜åŒ–
        String str1 = "Hello";
        String str2 = "World";
        String concatenated = str1.concat(str2);
        
        /*
         * æ–¹æ³•è°ƒç”¨çš„æ“ä½œæ•°æ ˆå˜åŒ–ï¼š
         * 
         * aload_1      // å‹å…¥str1å¼•ç”¨
         *              // æ ˆ: [str1_ref]
         * aload_2      // å‹å…¥str2å¼•ç”¨
         *              // æ ˆ: [str1_ref, str2_ref]
         * invokevirtual // è°ƒç”¨concatæ–¹æ³•
         *              // æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå‚æ•°ä»æ“ä½œæ•°æ ˆä¼ é€’ç»™è¢«è°ƒç”¨æ–¹æ³•
         *              // æ ˆ: [result_ref] (æ–¹æ³•è¿”å›å€¼)
         * astore_3     // å­˜å‚¨è¿”å›å€¼
         *              // æ ˆ: []
         */
        
        System.out.println("å­—ç¬¦ä¸²è¿æ¥ç»“æœ: " + concatenated);
    }
}
```

### 2.5 è™šæ‹Ÿæœºæ ˆçš„å¼‚å¸¸æƒ…å†µ

```java
// StackExceptionDemo.java - æ¼”ç¤ºè™šæ‹Ÿæœºæ ˆçš„å¼‚å¸¸æƒ…å†µ
public class StackExceptionDemo {
    private static int depth = 0;
    
    public static void main(String[] args) {
        System.out.println("=== è™šæ‹Ÿæœºæ ˆå¼‚å¸¸æ¼”ç¤º ===\n");
        
        // æ¼”ç¤ºStackOverflowError
        demonstrateStackOverflow();
    }
    
    private static void demonstrateStackOverflow() {
        try {
            recursiveMethod();
        } catch (StackOverflowError e) {
            System.out.println("\næ•è·åˆ°StackOverflowError!");
            System.out.println("é€’å½’æ·±åº¦è¾¾åˆ°: " + depth);
            System.out.println("é”™è¯¯ä¿¡æ¯: " + e.getMessage());
            
            // åˆ†ææ ˆæº¢å‡ºçš„åŸå› 
            analyzeStackOverflow();
        }
    }
    
    private static void recursiveMethod() {
        depth++;
        if (depth % 1000 == 0) {
            System.out.println("å½“å‰é€’å½’æ·±åº¦: " + depth);
        }
        
        // æ— é™é€’å½’ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šåˆ›å»ºæ–°çš„æ ˆå¸§
        recursiveMethod();
    }
    
    private static void analyzeStackOverflow() {
        System.out.println("\n=== StackOverflowErroråˆ†æ ===");
        System.out.println("1. æ¯æ¬¡æ–¹æ³•è°ƒç”¨éƒ½ä¼šåœ¨è™šæ‹Ÿæœºæ ˆä¸­åˆ›å»ºä¸€ä¸ªæ ˆå¸§");
        System.out.println("2. æ ˆå¸§åŒ…å«å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆç­‰ä¿¡æ¯");
        System.out.println("3. è™šæ‹Ÿæœºæ ˆçš„å¤§å°æ˜¯æœ‰é™çš„ï¼ˆé»˜è®¤1MBå·¦å³ï¼‰");
        System.out.println("4. é€’å½’è°ƒç”¨è¿‡æ·±ä¼šå¯¼è‡´æ ˆç©ºé—´è€—å°½");
        System.out.println("5. JVMæŠ›å‡ºStackOverflowErrorä¿æŠ¤ç³»ç»Ÿ");
        
        // æ¼”ç¤ºå¦‚ä½•è°ƒæ•´æ ˆå¤§å°
        System.out.println("\nå¯ä»¥é€šè¿‡JVMå‚æ•°è°ƒæ•´æ ˆå¤§å°ï¼š");
        System.out.println("-Xss<size>  ä¾‹å¦‚ï¼š-Xss2m (è®¾ç½®æ ˆå¤§å°ä¸º2MB)");
    }
}
```

**è¿è¡Œæµ‹è¯•ï¼š**

```bash
# ç¼–è¯‘å’Œè¿è¡Œ
javac StackExceptionDemo.java

# ä½¿ç”¨é»˜è®¤æ ˆå¤§å°è¿è¡Œ
java StackExceptionDemo

# ä½¿ç”¨æ›´å¤§çš„æ ˆå¤§å°è¿è¡Œ
java -Xss2m StackExceptionDemo

# ä½¿ç”¨æ›´å°çš„æ ˆå¤§å°è¿è¡Œ
java -Xss128k StackExceptionDemo
```

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæœ¬åœ°æ–¹æ³•æ ˆ(Native Method Stack)æ·±åº¦è§£æ

### 3.1 æœ¬åœ°æ–¹æ³•æ ˆçš„è®¾è®¡åŸç†

æœ¬åœ°æ–¹æ³•æ ˆä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„Nativeæ–¹æ³•æœåŠ¡ï¼Œä¸Javaè™šæ‹Ÿæœºæ ˆç±»ä¼¼ï¼Œä½†ä¸“é—¨ä¸ºæœ¬åœ°æ–¹æ³•å‡†å¤‡ã€‚

```java
// NativeMethodStackDemo.java - æ¼”ç¤ºæœ¬åœ°æ–¹æ³•æ ˆçš„ä½¿ç”¨
public class NativeMethodStackDemo {
    // å£°æ˜æœ¬åœ°æ–¹æ³•
    public native void nativeMethod();
    
    // åŠ è½½æœ¬åœ°åº“
    static {
        try {
            System.loadLibrary("nativelib");
        } catch (UnsatisfiedLinkError e) {
            System.out.println("æœ¬åœ°åº“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¼”ç¤º");
        }
    }
    
    public static void main(String[] args) {
        System.out.println("=== æœ¬åœ°æ–¹æ³•æ ˆæ¼”ç¤º ===\n");
        
        NativeMethodStackDemo demo = new NativeMethodStackDemo();
        
        // æ¼”ç¤ºJavaæ–¹æ³•è°ƒç”¨æœ¬åœ°æ–¹æ³•çš„è¿‡ç¨‹
        demonstrateNativeMethodCall();
        
        // æ¼”ç¤ºå¸¸è§çš„æœ¬åœ°æ–¹æ³•
        demonstrateCommonNativeMethods();
    }
    
    private static void demonstrateNativeMethodCall() {
        System.out.println("1. Javaæ–¹æ³•è°ƒç”¨æœ¬åœ°æ–¹æ³•çš„è¿‡ç¨‹ï¼š");
        System.out.println("   Javaæ–¹æ³•æ ˆå¸§ -> æœ¬åœ°æ–¹æ³•æ ˆå¸§ -> æœ¬åœ°ä»£ç æ‰§è¡Œ");
        
        // è°ƒç”¨System.currentTimeMillis() - è¿™æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•
        long startTime = System.currentTimeMillis();
        
        /*
         * è°ƒç”¨è¿‡ç¨‹åˆ†æï¼š
         * 1. Javaä»£ç è°ƒç”¨System.currentTimeMillis()
         * 2. JVMåœ¨æœ¬åœ°æ–¹æ³•æ ˆä¸­åˆ›å»ºæ ˆå¸§
         * 3. æ‰§è¡Œå¯¹åº”çš„C/C++ä»£ç 
         * 4. è¿”å›ç»“æœåˆ°Javaæ ˆ
         * 5. Javaä»£ç ç»§ç»­æ‰§è¡Œ
         */
        
        try {
            Thread.sleep(10); // å¦ä¸€ä¸ªæœ¬åœ°æ–¹æ³•è°ƒç”¨
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        long endTime = System.currentTimeMillis();
        
        System.out.println("   å¼€å§‹æ—¶é—´: " + startTime + " (é€šè¿‡æœ¬åœ°æ–¹æ³•è·å–)");
        System.out.println("   ç»“æŸæ—¶é—´: " + endTime + " (é€šè¿‡æœ¬åœ°æ–¹æ³•è·å–)");
        System.out.println("   è€—æ—¶: " + (endTime - startTime) + "ms\n");
    }
    
    private static void demonstrateCommonNativeMethods() {
        System.out.println("2. å¸¸è§çš„æœ¬åœ°æ–¹æ³•è°ƒç”¨ï¼š");
        
        // Object.hashCode() - æœ¬åœ°æ–¹æ³•
        Object obj = new Object();
        int hashCode = obj.hashCode();
        System.out.println("   Object.hashCode(): " + hashCode + " (æœ¬åœ°æ–¹æ³•)");
        
        // System.arraycopy() - æœ¬åœ°æ–¹æ³•
        int[] source = {1, 2, 3, 4, 5};
        int[] dest = new int[5];
        System.arraycopy(source, 0, dest, 0, 5);
        System.out.println("   System.arraycopy(): æ•°ç»„å¤åˆ¶å®Œæˆ (æœ¬åœ°æ–¹æ³•)");
        
        // Class.forName() - éƒ¨åˆ†å®ç°æ˜¯æœ¬åœ°æ–¹æ³•
        try {
            Class<?> clazz = Class.forName("java.lang.String");
            System.out.println("   Class.forName(): " + clazz.getName() + " (éƒ¨åˆ†æœ¬åœ°å®ç°)");
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        }
        
        // Threadç›¸å…³çš„æœ¬åœ°æ–¹æ³•
        Thread currentThread = Thread.currentThread();
        System.out.println("   Thread.currentThread(): " + currentThread.getName() + " (æœ¬åœ°æ–¹æ³•)");
        
        // æ–‡ä»¶I/Oç›¸å…³çš„æœ¬åœ°æ–¹æ³•
        java.io.File file = new java.io.File(".");
        boolean exists = file.exists();
        System.out.println("   File.exists(): " + exists + " (æœ¬åœ°æ–¹æ³•)");
        
        System.out.println();
    }
}
```

### 3.2 æœ¬åœ°æ–¹æ³•æ ˆçš„å†…å­˜ç®¡ç†

```java
// NativeStackMemoryDemo.java - æ¼”ç¤ºæœ¬åœ°æ–¹æ³•æ ˆçš„å†…å­˜ç‰¹æ€§
public class NativeStackMemoryDemo {
    public static void main(String[] args) {
        System.out.println("=== æœ¬åœ°æ–¹æ³•æ ˆå†…å­˜ç‰¹æ€§æ¼”ç¤º ===\n");
        
        // æ¼”ç¤ºæœ¬åœ°æ–¹æ³•æ ˆçš„çº¿ç¨‹ç§æœ‰ç‰¹æ€§
        demonstrateThreadPrivateNativeStack();
        
        // æ¼”ç¤ºæœ¬åœ°æ–¹æ³•æ ˆçš„å¼‚å¸¸æƒ…å†µ
        demonstrateNativeStackExceptions();
    }
    
    private static void demonstrateThreadPrivateNativeStack() {
        System.out.println("1. æœ¬åœ°æ–¹æ³•æ ˆçš„çº¿ç¨‹ç§æœ‰ç‰¹æ€§ï¼š");
        
        // åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„æœ¬åœ°æ–¹æ³•æ ˆ
        for (int i = 0; i < 3; i++) {
            final int threadId = i;
            Thread thread = new Thread(() -> {
                // æ¯ä¸ªçº¿ç¨‹è°ƒç”¨æœ¬åœ°æ–¹æ³•æ—¶ä½¿ç”¨ç‹¬ç«‹çš„æœ¬åœ°æ–¹æ³•æ ˆ
                long threadNativeId = Thread.currentThread().getId();
                String threadName = Thread.currentThread().getName();
                
                System.out.println("   çº¿ç¨‹" + threadId + ": " + threadName + 
                                 ", æœ¬åœ°ID: " + threadNativeId + " (ç‹¬ç«‹çš„æœ¬åœ°æ–¹æ³•æ ˆ)");
                
                // æ¨¡æ‹Ÿæœ¬åœ°æ–¹æ³•è°ƒç”¨
                try {
                    Thread.sleep(100); // æœ¬åœ°æ–¹æ³•è°ƒç”¨
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }, "NativeStackThread-" + i);
            
            thread.start();
        }
        
        // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
        try {
            Thread.sleep(500);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        System.out.println();
    }
    
    private static void demonstrateNativeStackExceptions() {
        System.out.println("2. æœ¬åœ°æ–¹æ³•æ ˆçš„å¼‚å¸¸æƒ…å†µï¼š");
        
        System.out.println("   - StackOverflowError: æœ¬åœ°æ–¹æ³•é€’å½’è°ƒç”¨è¿‡æ·±");
        System.out.println("   - OutOfMemoryError: æœ¬åœ°æ–¹æ³•æ ˆå†…å­˜ä¸è¶³");
        System.out.println("   - UnsatisfiedLinkError: æœ¬åœ°åº“åŠ è½½å¤±è´¥");
        
        // æ¼”ç¤ºUnsatisfiedLinkError
        try {
            System.loadLibrary("nonexistent_library");
        } catch (UnsatisfiedLinkError e) {
            System.out.println("   æ•è·UnsatisfiedLinkError: " + e.getMessage());
        }
        
        System.out.println();
    }
}
```

## ç¬¬å››éƒ¨åˆ†ï¼šå †å†…å­˜(Heap)æ·±åº¦è§£æ

### 4.1 å †å†…å­˜çš„è®¾è®¡åŸç†

æ ¹æ®JVMè§„èŒƒï¼Œå †æ˜¯Javaè™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ï¼Œæ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºã€‚

**OpenJDKæºç åˆ†æï¼š**

åœ¨`hotspot/src/share/vm/memory/universe.hpp`ä¸­å®šä¹‰äº†å †çš„ç»“æ„ï¼š

```cpp
// OpenJDKæºç ç‰‡æ®µ
class Universe: AllStatic {
private:
  static CollectedHeap* _collectedHeap;
  
public:
  static CollectedHeap* heap() { return _collectedHeap; }
  
  // Heap initialization
  static jint initialize_heap();
};

// åœ¨hotspot/src/share/vm/memory/collectedHeap.hppä¸­
class CollectedHeap : public CHeapObj<mtInternal> {
protected:
  MemRegion _reserved;     // Reserved heap memory
  
public:
  // Object allocation
  virtual HeapWord* allocate_new_tlab(size_t size);
  virtual void collect(GCCause::Cause cause);
};
```

### 4.2 å †å†…å­˜çš„åˆ†ä»£ç»“æ„

```java
// HeapStructureDemo.java - æ¼”ç¤ºå †å†…å­˜çš„åˆ†ä»£ç»“æ„
import java.lang.management.ManagementFactory;
import java.lang.management.MemoryMXBean;
import java.lang.management.MemoryUsage;
import java.util.ArrayList;
import java.util.List;

public class HeapStructureDemo {
    public static void main(String[] args) {
        System.out.println("=== å †å†…å­˜åˆ†ä»£ç»“æ„æ¼”ç¤º ===\n");
        
        // è·å–å†…å­˜ç®¡ç†Bean
        MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
        
        // æ¼”ç¤ºå¹´è½»ä»£å¯¹è±¡åˆ†é…
        demonstrateYoungGeneration();
        
        // æ¼”ç¤ºè€å¹´ä»£å¯¹è±¡åˆ†é…
        demonstrateOldGeneration();
        
        // æ¼”ç¤ºå¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£
        demonstrateLargeObjectAllocation();
    }
    
    private static void demonstrateYoungGeneration() {
        System.out.println("1. å¹´è½»ä»£å¯¹è±¡åˆ†é…æ¼”ç¤ºï¼š");
        
        // åˆ›å»ºå¤§é‡å°å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡ä¼šåœ¨å¹´è½»ä»£åˆ†é…
        List<String> youngObjects = new ArrayList<>();
        
        for (int i = 0; i < 10000; i++) {
            // æ–°åˆ›å»ºçš„å¯¹è±¡é¦–å…ˆåœ¨EdenåŒºåˆ†é…
            String obj = new String("å¹´è½»ä»£å¯¹è±¡_" + i);
            
            if (i < 100) {
                // ä¿æŒå‰100ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œå…¶ä»–çš„æˆä¸ºåƒåœ¾
                youngObjects.add(obj);
            }
            
            if (i % 2000 == 0) {
                printMemoryUsage("åˆ›å»ºäº† " + (i + 1) + " ä¸ªå¹´è½»ä»£å¯¹è±¡");
            }
        }
        
        System.out.println("   å¹´è½»ä»£å¯¹è±¡ç‰¹ç‚¹ï¼š");
        System.out.println("   - æ–°åˆ›å»ºçš„å¯¹è±¡é¦–å…ˆåœ¨EdenåŒºåˆ†é…");
        System.out.println("   - å¤§éƒ¨åˆ†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œå¾ˆå¿«æˆä¸ºåƒåœ¾");
        System.out.println("   - ç»è¿‡å‡ æ¬¡Minor GCåï¼Œå­˜æ´»å¯¹è±¡è¿›å…¥è€å¹´ä»£\n");
    }
    
    private static void demonstrateOldGeneration() {
        System.out.println("2. è€å¹´ä»£å¯¹è±¡æ¼”ç¤ºï¼š");
        
        // åˆ›å»ºé•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡
        List<byte[]> longLivedObjects = new ArrayList<>();
        
        for (int i = 0; i < 50; i++) {
            // åˆ›å»ºä¸­ç­‰å¤§å°çš„å¯¹è±¡ï¼Œå¹¶ä¿æŒå¼•ç”¨
            byte[] longLivedObject = new byte[1024 * 100]; // 100KB
            longLivedObjects.add(longLivedObject);
            
            if (i % 10 == 0) {
                printMemoryUsage("åˆ›å»ºäº† " + (i + 1) + " ä¸ªé•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡");
            }
        }
        
        // è§¦å‘åƒåœ¾å›æ”¶ï¼Œè§‚å¯Ÿå¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£
        System.gc();
        
        try {
            Thread.sleep(100); // ç­‰å¾…GCå®Œæˆ
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        printMemoryUsage("åƒåœ¾å›æ”¶å");
        
        System.out.println("   è€å¹´ä»£å¯¹è±¡ç‰¹ç‚¹ï¼š");
        System.out.println("   - ä»å¹´è½»ä»£æ™‹å‡çš„é•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡");
        System.out.println("   - å¤§å¯¹è±¡å¯èƒ½ç›´æ¥åˆ†é…åœ¨è€å¹´ä»£");
        System.out.println("   - è€å¹´ä»£GCé¢‘ç‡è¾ƒä½ï¼Œä½†è€—æ—¶è¾ƒé•¿\n");
    }
    
    private static void demonstrateLargeObjectAllocation() {
        System.out.println("3. å¤§å¯¹è±¡åˆ†é…æ¼”ç¤ºï¼š");
        
        printMemoryUsage("åˆ†é…å¤§å¯¹è±¡å‰");
        
        // åˆ›å»ºå¤§å¯¹è±¡ï¼Œå¯èƒ½ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…
        byte[] largeObject1 = new byte[1024 * 1024 * 2]; // 2MB
        printMemoryUsage("åˆ†é…ç¬¬ä¸€ä¸ªå¤§å¯¹è±¡å");
        
        byte[] largeObject2 = new byte[1024 * 1024 * 3]; // 3MB
        printMemoryUsage("åˆ†é…ç¬¬äºŒä¸ªå¤§å¯¹è±¡å");
        
        System.out.println("   å¤§å¯¹è±¡åˆ†é…ç‰¹ç‚¹ï¼š");
        System.out.println("   - è¶…è¿‡ä¸€å®šé˜ˆå€¼çš„å¯¹è±¡ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…");
        System.out.println("   - é¿å…åœ¨å¹´è½»ä»£é¢‘ç¹å¤åˆ¶å¤§å¯¹è±¡");
        System.out.println("   - å¯é€šè¿‡-XX:PretenureSizeThresholdå‚æ•°æ§åˆ¶é˜ˆå€¼\n");
        
        // æ¸…ç†å¼•ç”¨ï¼Œä½¿å¯¹è±¡å¯ä»¥è¢«å›æ”¶
        largeObject1 = null;
        largeObject2 = null;
    }
    
    private static void printMemoryUsage(String phase) {
        MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
        MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
        
        long used = heapUsage.getUsed() / 1024 / 1024; // MB
        long max = heapUsage.getMax() / 1024 / 1024;   // MB
        
        System.out.println(String.format("   %s: å †å†…å­˜ä½¿ç”¨ %dMB / %dMB", 
                                        phase, used, max));
    }
}
```

### 4.3 å¯¹è±¡åˆ†é…è¿‡ç¨‹è¯¦è§£

```java
// ObjectAllocationDemo.java - æ¼”ç¤ºå¯¹è±¡åˆ†é…çš„è¯¦ç»†è¿‡ç¨‹
import java.lang.management.ManagementFactory;
import java.lang.management.GarbageCollectorMXBean;
import java.util.List;

public class ObjectAllocationDemo {
    public static void main(String[] args) {
        System.out.println("=== å¯¹è±¡åˆ†é…è¿‡ç¨‹è¯¦è§£ ===\n");
        
        // æ¼”ç¤ºTLABåˆ†é…
        demonstrateTLABAllocation();
        
        // æ¼”ç¤ºå¯¹è±¡æ™‹å‡è¿‡ç¨‹
        demonstrateObjectPromotion();
        
        // æ¼”ç¤ºåˆ†é…å¤±è´¥å¤„ç†
        demonstrateAllocationFailure();
    }
    
    private static void demonstrateTLABAllocation() {
        System.out.println("1. TLAB(Thread Local Allocation Buffer)åˆ†é…æ¼”ç¤ºï¼š");
        
        /*
         * TLABåˆ†é…è¿‡ç¨‹ï¼š
         * 1. æ¯ä¸ªçº¿ç¨‹åœ¨EdenåŒºéƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„åˆ†é…ç¼“å†²åŒº
         * 2. å¯¹è±¡ä¼˜å…ˆåœ¨TLABä¸­åˆ†é…ï¼Œé¿å…çº¿ç¨‹åŒæ­¥å¼€é”€
         * 3. TLABç”¨å®Œåï¼Œçº¿ç¨‹ç”³è¯·æ–°çš„TLAB
         * 4. å¦‚æœEdenåŒºç©ºé—´ä¸è¶³ï¼Œè§¦å‘Minor GC
         */
        
        // åˆ›å»ºå¤šä¸ªçº¿ç¨‹åŒæ—¶åˆ†é…å¯¹è±¡
        Thread[] threads = new Thread[3];
        
        for (int i = 0; i < threads.length; i++) {
            final int threadId = i;
            threads[i] = new Thread(() -> {
                System.out.println("   çº¿ç¨‹" + threadId + "å¼€å§‹åœ¨TLABä¸­åˆ†é…å¯¹è±¡");
                
                // æ¯ä¸ªçº¿ç¨‹åˆ†é…å¤§é‡å°å¯¹è±¡
                for (int j = 0; j < 1000; j++) {
                    Object obj = new Object();
                    // å¯¹è±¡åœ¨å½“å‰çº¿ç¨‹çš„TLABä¸­åˆ†é…
                }
                
                System.out.println("   çº¿ç¨‹" + threadId + "å®Œæˆå¯¹è±¡åˆ†é…");
            }, "TLABThread-" + i);
        }
        
        // å¯åŠ¨æ‰€æœ‰çº¿ç¨‹
        for (Thread thread : threads) {
            thread.start();
        }
        
        // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
        for (Thread thread : threads) {
            try {
                thread.join();
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
        
        System.out.println("   TLABåˆ†é…ä¼˜åŠ¿ï¼š");
        System.out.println("   - çº¿ç¨‹ç§æœ‰ï¼Œæ— éœ€åŒæ­¥ï¼Œåˆ†é…é€Ÿåº¦å¿«");
        System.out.println("   - å‡å°‘å†…å­˜ç¢ç‰‡");
        System.out.println("   - æé«˜ç¼“å­˜å±€éƒ¨æ€§\n");
    }
    
    private static void demonstrateObjectPromotion() {
        System.out.println("2. å¯¹è±¡æ™‹å‡è¿‡ç¨‹æ¼”ç¤ºï¼š");
        
        // è®°å½•GCå‰çš„çŠ¶æ€
        long gcCountBefore = getGCCount();
        
        // åˆ›å»ºä¸€äº›é•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡
        Object[] survivorObjects = new Object[1000];
        
        for (int generation = 0; generation < 5; generation++) {
            System.out.println("   ç¬¬" + (generation + 1) + "è½®å¯¹è±¡åˆ›å»ºï¼š");
            
            // åˆ›å»ºå¤§é‡çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡
            for (int i = 0; i < 10000; i++) {
                Object shortLived = new Object();
                // è¿™äº›å¯¹è±¡å¾ˆå¿«æˆä¸ºåƒåœ¾
            }
            
            // ä¿æŒä¸€äº›å¯¹è±¡å­˜æ´»
            for (int i = 0; i < survivorObjects.length; i++) {
                if (survivorObjects[i] == null) {
                    survivorObjects[i] = new Object();
                }
            }
            
            // è§¦å‘Minor GC
            System.gc();
            
            try {
                Thread.sleep(50);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            
            long gcCountAfter = getGCCount();
            System.out.println("     GCæ¬¡æ•°: " + (gcCountAfter - gcCountBefore));
        }
        
        System.out.println("   å¯¹è±¡æ™‹å‡è§„åˆ™ï¼š");
        System.out.println("   - å¯¹è±¡å¹´é¾„è¾¾åˆ°é˜ˆå€¼(é»˜è®¤15)åæ™‹å‡åˆ°è€å¹´ä»£");
        System.out.println("   - SurvivoråŒºç©ºé—´ä¸è¶³æ—¶ï¼Œå¯¹è±¡ç›´æ¥æ™‹å‡");
        System.out.println("   - åŠ¨æ€å¹´é¾„åˆ¤æ–­ï¼šåŒå¹´é¾„å¯¹è±¡å¤§å°è¶…è¿‡Survivorä¸€åŠæ—¶æ™‹å‡\n");
    }
    
    private static void demonstrateAllocationFailure() {
        System.out.println("3. åˆ†é…å¤±è´¥å¤„ç†æ¼”ç¤ºï¼š");
        
        try {
            // å°è¯•åˆ†é…å¤§é‡å†…å­˜ï¼Œæ¨¡æ‹Ÿåˆ†é…å¤±è´¥
            java.util.List<byte[]> memoryEater = new java.util.ArrayList<>();
            
            for (int i = 0; i < 1000; i++) {
                // åˆ†é…1MBçš„æ•°ç»„
                byte[] chunk = new byte[1024 * 1024];
                memoryEater.add(chunk);
                
                if (i % 100 == 0) {
                    System.out.println("   å·²åˆ†é… " + (i + 1) + " MBå†…å­˜");
                }
            }
            
        } catch (OutOfMemoryError e) {
            System.out.println("   æ•è·OutOfMemoryError: " + e.getMessage());
            
            System.out.println("   åˆ†é…å¤±è´¥å¤„ç†è¿‡ç¨‹ï¼š");
            System.out.println("   1. EdenåŒºç©ºé—´ä¸è¶³ï¼Œè§¦å‘Minor GC");
            System.out.println("   2. GCåä»æ— è¶³å¤Ÿç©ºé—´ï¼Œå°è¯•åœ¨è€å¹´ä»£åˆ†é…");
            System.out.println("   3. è€å¹´ä»£ç©ºé—´ä¸è¶³ï¼Œè§¦å‘Full GC");
            System.out.println("   4. Full GCåä»æ— è¶³å¤Ÿç©ºé—´ï¼ŒæŠ›å‡ºOutOfMemoryError");
        }
        
        System.out.println();
    }
    
    private static long getGCCount() {
        long totalGCCount = 0;
        List<GarbageCollectorMXBean> gcBeans = ManagementFactory.getGarbageCollectorMXBeans();
        
        for (GarbageCollectorMXBean gcBean : gcBeans) {
            totalGCCount += gcBean.getCollectionCount();
        }
        
        return totalGCCount;
    }
}
```

### 4.4 å †å†…å­˜çš„ç›‘æ§å’Œè°ƒä¼˜

```java
// HeapMonitoringDemo.java - æ¼”ç¤ºå †å†…å­˜çš„ç›‘æ§å’Œè°ƒä¼˜
import java.lang.management.*;
import java.util.List;

public class HeapMonitoringDemo {
    public static void main(String[] args) {
        System.out.println("=== å †å†…å­˜ç›‘æ§å’Œè°ƒä¼˜æ¼”ç¤º ===\n");
        
        // è·å–å†…å­˜ç®¡ç†ç›¸å…³çš„MXBean
        MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
        List<MemoryPoolMXBean> memoryPools = ManagementFactory.getMemoryPoolMXBeans();
        List<GarbageCollectorMXBean> gcBeans = ManagementFactory.getGarbageCollectorMXBeans();
        
        // æ˜¾ç¤ºå †å†…å­˜é…ç½®
        displayHeapConfiguration(memoryBean, memoryPools);
        
        // ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
        monitorMemoryUsage(memoryBean, memoryPools, gcBeans);
        
        // æ¼”ç¤ºå†…å­˜è°ƒä¼˜å‚æ•°
        demonstrateTuningParameters();
    }
    
    private static void displayHeapConfiguration(MemoryMXBean memoryBean, 
                                               List<MemoryPoolMXBean> memoryPools) {
        System.out.println("1. å †å†…å­˜é…ç½®ä¿¡æ¯ï¼š");
        
        MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
        System.out.println("   å †å†…å­˜æ€»é…ç½®ï¼š");
        System.out.println("     åˆå§‹å¤§å°: " + formatMemory(heapUsage.getInit()));
        System.out.println("     å½“å‰ä½¿ç”¨: " + formatMemory(heapUsage.getUsed()));
        System.out.println("     å·²æäº¤: " + formatMemory(heapUsage.getCommitted()));
        System.out.println("     æœ€å¤§å¤§å°: " + formatMemory(heapUsage.getMax()));
        
        System.out.println("\n   å„å†…å­˜æ± è¯¦ç»†ä¿¡æ¯ï¼š");
        for (MemoryPoolMXBean pool : memoryPools) {
            if (pool.getType() == MemoryType.HEAP) {
                MemoryUsage usage = pool.getUsage();
                System.out.println("     " + pool.getName() + ":");
                System.out.println("       ä½¿ç”¨: " + formatMemory(usage.getUsed()) + 
                                 " / " + formatMemory(usage.getMax()));
            }
        }
        System.out.println();
    }
    
    private static void monitorMemoryUsage(MemoryMXBean memoryBean,
                                          List<MemoryPoolMXBean> memoryPools,
                                          List<GarbageCollectorMXBean> gcBeans) {
        System.out.println("2. å†…å­˜ä½¿ç”¨ç›‘æ§ï¼š");
        
        // è®°å½•åˆå§‹çŠ¶æ€
        long initialGCCount = getTotalGCCount(gcBeans);
        long initialGCTime = getTotalGCTime(gcBeans);
        
        // æ¨¡æ‹Ÿå†…å­˜ä½¿ç”¨
        simulateMemoryUsage();
        
        // è®°å½•ç»“æŸçŠ¶æ€
        long finalGCCount = getTotalGCCount(gcBeans);
        long finalGCTime = getTotalGCTime(gcBeans);
        
        System.out.println("   GCç»Ÿè®¡ä¿¡æ¯ï¼š");
        System.out.println("     GCæ¬¡æ•°: " + (finalGCCount - initialGCCount));
        System.out.println("     GCè€—æ—¶: " + (finalGCTime - initialGCTime) + "ms");
        
        // æ˜¾ç¤ºå„åƒåœ¾æ”¶é›†å™¨çš„è¯¦ç»†ä¿¡æ¯
        System.out.println("\n   åƒåœ¾æ”¶é›†å™¨è¯¦ç»†ä¿¡æ¯ï¼š");
        for (GarbageCollectorMXBean gcBean : gcBeans) {
            System.out.println("     " + gcBean.getName() + ":");
            System.out.println("       æ”¶é›†æ¬¡æ•°: " + gcBean.getCollectionCount());
            System.out.println("       æ”¶é›†è€—æ—¶: " + gcBean.getCollectionTime() + "ms");
            System.out.println("       ç®¡ç†çš„å†…å­˜æ± : " + 
                             String.join(", ", gcBean.getMemoryPoolNames()));
        }
        System.out.println();
    }
    
    private static void simulateMemoryUsage() {
        // åˆ›å»ºä¸åŒç±»å‹çš„å¯¹è±¡æ¥æ¨¡æ‹ŸçœŸå®åº”ç”¨çš„å†…å­˜ä½¿ç”¨æ¨¡å¼
        java.util.List<Object> objects = new java.util.ArrayList<>();
        
        // é˜¶æ®µ1ï¼šåˆ›å»ºå¤§é‡å°å¯¹è±¡
        for (int i = 0; i < 50000; i++) {
            objects.add(new String("å°å¯¹è±¡_" + i));
            
            // ä¿æŒéƒ¨åˆ†å¯¹è±¡ï¼Œè®©éƒ¨åˆ†æˆä¸ºåƒåœ¾
            if (i % 10 == 0) {
                objects.remove(0);
            }
        }
        
        // é˜¶æ®µ2ï¼šåˆ›å»ºä¸­ç­‰å¤§å°å¯¹è±¡
        for (int i = 0; i < 100; i++) {
            objects.add(new byte[1024 * 10]); // 10KB
        }
        
        // é˜¶æ®µ3ï¼šè§¦å‘GC
        System.gc();
        
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    private static void demonstrateTuningParameters() {
        System.out.println("3. å †å†…å­˜è°ƒä¼˜å‚æ•°ï¼š");
        
        System.out.println("   åŸºç¡€å‚æ•°ï¼š");
        System.out.println("     -Xms<size>    è®¾ç½®åˆå§‹å †å¤§å°");
        System.out.println("     -Xmx<size>    è®¾ç½®æœ€å¤§å †å¤§å°");
        System.out.println("     -Xmn<size>    è®¾ç½®å¹´è½»ä»£å¤§å°");
        
        System.out.println("\n   å¹´è½»ä»£å‚æ•°ï¼š");
        System.out.println("     -XX:NewRatio=<ratio>           è€å¹´ä»£/å¹´è½»ä»£æ¯”ä¾‹");
        System.out.println("     -XX:SurvivorRatio=<ratio>      Eden/Survivoræ¯”ä¾‹");
        System.out.println("     -XX:MaxTenuringThreshold=<n>   å¯¹è±¡æ™‹å‡å¹´é¾„é˜ˆå€¼");
        
        System.out.println("\n   TLABå‚æ•°ï¼š");
        System.out.println("     -XX:+UseTLAB              å¯ç”¨TLAB");
        System.out.println("     -XX:TLABSize=<size>       è®¾ç½®TLABå¤§å°");
        System.out.println("     -XX:TLABWasteTargetPercent=<percent>  TLABæµªè´¹é˜ˆå€¼");
        
        System.out.println("\n   å¤§å¯¹è±¡å‚æ•°ï¼š");
        System.out.println("     -XX:PretenureSizeThreshold=<size>  å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£çš„é˜ˆå€¼");
        
        System.out.println("\n   ç›‘æ§å‚æ•°ï¼š");
        System.out.println("     -XX:+PrintGC              æ‰“å°GCä¿¡æ¯");
        System.out.println("     -XX:+PrintGCDetails       æ‰“å°è¯¦ç»†GCä¿¡æ¯");
        System.out.println("     -XX:+PrintGCTimeStamps    æ‰“å°GCæ—¶é—´æˆ³");
        System.out.println("     -Xloggc:<file>            GCæ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶");
        
        System.out.println();
    }
    
    private static long getTotalGCCount(List<GarbageCollectorMXBean> gcBeans) {
        return gcBeans.stream().mapToLong(GarbageCollectorMXBean::getCollectionCount).sum();
    }
    
    private static long getTotalGCTime(List<GarbageCollectorMXBean> gcBeans) {
        return gcBeans.stream().mapToLong(GarbageCollectorMXBean::getCollectionTime).sum();
    }
    
    private static String formatMemory(long bytes) {
        if (bytes < 0) return "æœªçŸ¥";
        
        long mb = bytes / 1024 / 1024;
        if (mb > 1024) {
            return String.format("%.1fGB", mb / 1024.0);
        } else {
            return mb + "MB";
        }
    }
}
```

## ç¬¬äº”éƒ¨åˆ†ï¼šæ–¹æ³•åŒº(Method Area)æ·±åº¦è§£æ

### 5.1 æ–¹æ³•åŒºçš„è®¾è®¡åŸç†

æ ¹æ®JVMè§„èŒƒï¼Œæ–¹æ³•åŒºæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚

**OpenJDKæºç åˆ†æï¼š**

åœ¨HotSpot VMä¸­ï¼Œæ–¹æ³•åŒºçš„å®ç°ç»å†äº†ä»æ°¸ä¹…ä»£(PermGen)åˆ°å…ƒç©ºé—´(Metaspace)çš„æ¼”è¿›ï¼š

```cpp
// OpenJDK 8ä¹‹å‰çš„PermGenå®ç°
class PermGen : public Generation {
private:
  // Permanent generation for class metadata
  ContiguousSpace* _the_space;
  
public:
  // Class loading and unloading
  void allocate_class_metadata(size_t size);
};

// OpenJDK 8ä¹‹åçš„Metaspaceå®ç°
class Metaspace : public CHeapObj<mtClass> {
private:
  // Native memory for class metadata
  MetaspaceChunk* _chunk_list;
  
public:
  // Allocate metadata in native memory
  MetaWord* allocate(size_t size, MetadataType type);
};
```

### 5.2 æ–¹æ³•åŒºçš„å†…å®¹ç»“æ„

```java
// MethodAreaDemo.java - æ¼”ç¤ºæ–¹æ³•åŒºçš„å†…å®¹ç»“æ„
import java.lang.reflect.*;

public class MethodAreaDemo {
    // ç±»å˜é‡ - å­˜å‚¨åœ¨æ–¹æ³•åŒº
    private static String staticField = "é™æ€å­—æ®µ";
    private static final String CONSTANT_FIELD = "å¸¸é‡å­—æ®µ";
    
    // å®ä¾‹å˜é‡ - ä¸å­˜å‚¨åœ¨æ–¹æ³•åŒº
    private String instanceField = "å®ä¾‹å­—æ®µ";
    
    public static void main(String[] args) {
        System.out.println("=== æ–¹æ³•åŒºå†…å®¹ç»“æ„æ¼”ç¤º ===\n");
        
        // æ¼”ç¤ºç±»ä¿¡æ¯å­˜å‚¨
        demonstrateClassInformation();
        
        // æ¼”ç¤ºå¸¸é‡æ± 
        demonstrateConstantPool();
        
        // æ¼”ç¤ºé™æ€å˜é‡
        demonstrateStaticVariables();
        
        // æ¼”ç¤ºæ–¹æ³•ä¿¡æ¯
        demonstrateMethodInformation();
    }
    
    private static void demonstrateClassInformation() {
        System.out.println("1. ç±»ä¿¡æ¯å­˜å‚¨æ¼”ç¤ºï¼š");
        
        Class<?> clazz = MethodAreaDemo.class;
        
        System.out.println("   ç±»çš„åŸºæœ¬ä¿¡æ¯ï¼ˆå­˜å‚¨åœ¨æ–¹æ³•åŒºï¼‰ï¼š");
        System.out.println("     ç±»å: " + clazz.getName());
        System.out.println("     çˆ¶ç±»: " + clazz.getSuperclass().getName());
        System.out.println("     æ¥å£: " + java.util.Arrays.toString(clazz.getInterfaces()));
        System.out.println("     ä¿®é¥°ç¬¦: " + Modifier.toString(clazz.getModifiers()));
        
        // å­—æ®µä¿¡æ¯
        System.out.println("\n   å­—æ®µä¿¡æ¯ï¼š");
        Field[] fields = clazz.getDeclaredFields();
        for (Field field : fields) {
            System.out.println("     " + field.getName() + ": " + 
                             field.getType().getSimpleName() + 
                             " (" + Modifier.toString(field.getModifiers()) + ")");
        }
        
        // æ–¹æ³•ä¿¡æ¯
        System.out.println("\n   æ–¹æ³•ä¿¡æ¯ï¼š");
        Method[] methods = clazz.getDeclaredMethods();
        for (Method method : methods) {
            System.out.println("     " + method.getName() + "(): " + 
                             method.getReturnType().getSimpleName() + 
                             " (" + Modifier.toString(method.getModifiers()) + ")");
        }
        
        System.out.println();
    }
    
    private static void demonstrateConstantPool() {
        System.out.println("2. è¿è¡Œæ—¶å¸¸é‡æ± æ¼”ç¤ºï¼š");
        
        // å­—ç¬¦ä¸²å­—é¢é‡å­˜å‚¨åœ¨å¸¸é‡æ± ä¸­
        String literal1 = "Hello";
        String literal2 = "Hello";
        String literal3 = "World";
        
        System.out.println("   å­—ç¬¦ä¸²å­—é¢é‡ï¼š");
        System.out.println("     literal1 == literal2: " + (literal1 == literal2));
        System.out.println("     åŸå› ï¼šç›¸åŒå­—ç¬¦ä¸²å­—é¢é‡åœ¨å¸¸é‡æ± ä¸­åªå­˜å‚¨ä¸€ä»½");
        
        // è¿è¡Œæ—¶åˆ›å»ºçš„å­—ç¬¦ä¸²
        String runtime1 = new String("Hello");
        String runtime2 = new String("Hello");
        
        System.out.println("\n   è¿è¡Œæ—¶åˆ›å»ºçš„å­—ç¬¦ä¸²ï¼š");
        System.out.println("     runtime1 == runtime2: " + (runtime1 == runtime2));
        System.out.println("     runtime1.equals(runtime2): " + runtime1.equals(runtime2));
        System.out.println("     åŸå› ï¼šnew String()åœ¨å †ä¸­åˆ›å»ºæ–°å¯¹è±¡");
        
        // intern()æ–¹æ³•
        String interned = runtime1.intern();
        System.out.println("\n   intern()æ–¹æ³•ï¼š");
        System.out.println("     runtime1.intern() == literal1: " + (interned == literal1));
      System.out.println("     åŸå› ï¼šintern()è¿”å›å¸¸é‡æ± ä¸­çš„å¼•ç”¨");
        
        System.out.println();
    }
    
    private static void demonstrateStaticVariables() {
        System.out.println("3. é™æ€å˜é‡å­˜å‚¨æ¼”ç¤ºï¼š");
        
        System.out.println("   é™æ€å˜é‡å­˜å‚¨åœ¨æ–¹æ³•åŒºï¼š");
        System.out.println("     staticField: " + staticField);
        System.out.println("     CONSTANT_FIELD: " + CONSTANT_FIELD);
        
        // ä¿®æ”¹é™æ€å˜é‡
        String oldValue = staticField;
        staticField = "ä¿®æ”¹åçš„é™æ€å­—æ®µ";
        
        System.out.println("\n   é™æ€å˜é‡ä¿®æ”¹ï¼š");
        System.out.println("     ä¿®æ”¹å‰: " + oldValue);
        System.out.println("     ä¿®æ”¹å: " + staticField);
        System.out.println("     è¯´æ˜ï¼šé™æ€å˜é‡åœ¨æ–¹æ³•åŒºä¸­ï¼Œæ‰€æœ‰å®ä¾‹å…±äº«");
        
        // æ¼”ç¤ºç±»åˆå§‹åŒ–
        System.out.println("\n   ç±»åˆå§‹åŒ–è¿‡ç¨‹ï¼š");
        StaticInitDemo.accessStaticField();
        
        System.out.println();
    }
    
    private static void demonstrateMethodInformation() {
        System.out.println("4. æ–¹æ³•ä¿¡æ¯å­˜å‚¨æ¼”ç¤ºï¼š");
        
        try {
            Method method = MethodAreaDemo.class.getDeclaredMethod("demonstrateMethodInformation");
            
            System.out.println("   æ–¹æ³•å…ƒä¿¡æ¯ï¼ˆå­˜å‚¨åœ¨æ–¹æ³•åŒºï¼‰ï¼š");
            System.out.println("     æ–¹æ³•å: " + method.getName());
            System.out.println("     è¿”å›ç±»å‹: " + method.getReturnType().getSimpleName());
            System.out.println("     å‚æ•°ç±»å‹: " + java.util.Arrays.toString(method.getParameterTypes()));
            System.out.println("     ä¿®é¥°ç¬¦: " + Modifier.toString(method.getModifiers()));
            
            // æ–¹æ³•å­—èŠ‚ç ä¿¡æ¯
            System.out.println("\n   æ–¹æ³•å­—èŠ‚ç ä¿¡æ¯ï¼š");
            System.out.println("     å­—èŠ‚ç æŒ‡ä»¤å­˜å‚¨åœ¨æ–¹æ³•åŒº");
            System.out.println("     åŒ…å«æ“ä½œç ã€æ“ä½œæ•°ã€å¼‚å¸¸è¡¨ç­‰");
            System.out.println("     JITç¼–è¯‘åçš„æœºå™¨ç ä¹Ÿå¯èƒ½ç¼“å­˜åœ¨æ–¹æ³•åŒº");
            
        } catch (NoSuchMethodException e) {
            e.printStackTrace();
        }
        
        System.out.println();
    }
}
 
 // æ¼”ç¤ºç±»åˆå§‹åŒ–çš„è¾…åŠ©ç±»
 class StaticInitDemo {
    static {
        System.out.println("     StaticInitDemoç±»æ­£åœ¨åˆå§‹åŒ–...");
        System.out.println("     é™æ€åˆå§‹åŒ–å—åœ¨ç±»åŠ è½½æ—¶æ‰§è¡Œ");
    }
    
    private static String staticField = initStaticField();
    
    private static String initStaticField() {
        System.out.println("     é™æ€å­—æ®µåˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œ");
        return "é™æ€å­—æ®µå€¼";
    }
    
    public static void accessStaticField() {
         System.out.println("     è®¿é—®é™æ€å­—æ®µ: " + staticField);
     }
 }

### 5.3 å…ƒç©ºé—´(Metaspace)æ·±åº¦è§£æ

```java
// MetaspaceDemo.java - æ¼”ç¤ºå…ƒç©ºé—´çš„ç‰¹æ€§
import java.lang.management.ManagementFactory;
import java.lang.management.MemoryMXBean;
import java.lang.management.MemoryPoolMXBean;
import java.lang.management.MemoryUsage;
import java.util.List;

public class MetaspaceDemo {
    public static void main(String[] args) {
        System.out.println("=== å…ƒç©ºé—´(Metaspace)æ¼”ç¤º ===\n");
        
        // æ˜¾ç¤ºå…ƒç©ºé—´é…ç½®
        displayMetaspaceConfiguration();
        
        // æ¼”ç¤ºç±»åŠ è½½å¯¹å…ƒç©ºé—´çš„å½±å“
        demonstrateClassLoadingImpact();
        
        // æ¼”ç¤ºå…ƒç©ºé—´çš„ä¼˜åŠ¿
        demonstrateMetaspaceAdvantages();
    }
    
    private static void displayMetaspaceConfiguration() {
        System.out.println("1. å…ƒç©ºé—´é…ç½®ä¿¡æ¯ï¼š");
        
        MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
        List<MemoryPoolMXBean> memoryPools = ManagementFactory.getMemoryPoolMXBeans();
        
        for (MemoryPoolMXBean pool : memoryPools) {
            if (pool.getName().contains("Metaspace")) {
                MemoryUsage usage = pool.getUsage();
                System.out.println("   " + pool.getName() + ":");
                System.out.println("     å·²ä½¿ç”¨: " + formatMemory(usage.getUsed()));
                System.out.println("     å·²æäº¤: " + formatMemory(usage.getCommitted()));
                System.out.println("     æœ€å¤§å€¼: " + 
                                 (usage.getMax() == -1 ? "æ— é™åˆ¶" : formatMemory(usage.getMax())));
            }
        }
        
        System.out.println("\n   å…ƒç©ºé—´ç‰¹ç‚¹ï¼š");
        System.out.println("   - ä½¿ç”¨æœ¬åœ°å†…å­˜ï¼Œä¸å—å †å¤§å°é™åˆ¶");
        System.out.println("   - é»˜è®¤æƒ…å†µä¸‹åªå—ç³»ç»Ÿå†…å­˜é™åˆ¶");
        System.out.println("   - ç±»å¸è½½æ—¶è‡ªåŠ¨é‡Šæ”¾å…ƒç©ºé—´å†…å­˜");
        System.out.println();
    }
    
    private static void demonstrateClassLoadingImpact() {
        System.out.println("2. ç±»åŠ è½½å¯¹å…ƒç©ºé—´çš„å½±å“ï¼š");
        
        // è®°å½•åŠ è½½å‰çš„å…ƒç©ºé—´ä½¿ç”¨æƒ…å†µ
        long metaspaceBefore = getMetaspaceUsed();
        
        // åŠ¨æ€åŠ è½½ç±»
        try {
            ClassLoader classLoader = new CustomClassLoader();
            
            for (int i = 0; i < 10; i++) {
                String className = "DynamicClass" + i;
                Class<?> dynamicClass = classLoader.loadClass(className);
                System.out.println("   åŠ è½½ç±»: " + dynamicClass.getName());
            }
            
        } catch (ClassNotFoundException e) {
            System.out.println("   æ¨¡æ‹Ÿç±»åŠ è½½ï¼ˆå®é™…ç±»ä¸å­˜åœ¨ï¼‰");
        }
        
        long metaspaceAfter = getMetaspaceUsed();
        
        System.out.println("\n   å…ƒç©ºé—´ä½¿ç”¨å˜åŒ–ï¼š");
        System.out.println("     åŠ è½½å‰: " + formatMemory(metaspaceBefore));
        System.out.println("     åŠ è½½å: " + formatMemory(metaspaceAfter));
        System.out.println("     å¢é•¿: " + formatMemory(metaspaceAfter - metaspaceBefore));
        System.out.println();
    }
    
    private static void demonstrateMetaspaceAdvantages() {
        System.out.println("3. å…ƒç©ºé—´ç›¸æ¯”æ°¸ä¹…ä»£çš„ä¼˜åŠ¿ï¼š");
        
        System.out.println("   æ°¸ä¹…ä»£çš„é—®é¢˜ï¼š");
        System.out.println("   - å›ºå®šå¤§å°ï¼Œå®¹æ˜“å‘ç”ŸOutOfMemoryError");
        System.out.println("   - ä¸å †å…±äº«å†…å­˜ï¼Œå½±å“å †çš„ä½¿ç”¨");
        System.out.println("   - åƒåœ¾å›æ”¶æ•ˆç‡ä½");
        
        System.out.println("\n   å…ƒç©ºé—´çš„ä¼˜åŠ¿ï¼š");
        System.out.println("   - ä½¿ç”¨æœ¬åœ°å†…å­˜ï¼Œå¤§å°å¯åŠ¨æ€è°ƒæ•´");
        System.out.println("   - ä¸å½±å“å †å†…å­˜çš„ä½¿ç”¨");
        System.out.println("   - ç±»å¸è½½æ—¶è‡ªåŠ¨å›æ”¶ï¼Œæ— éœ€ç‰¹æ®ŠGC");
        System.out.println("   - å‡å°‘äº†OutOfMemoryErrorçš„å‘ç”Ÿ");
        
        System.out.println("\n   å…ƒç©ºé—´è°ƒä¼˜å‚æ•°ï¼š");
        System.out.println("   -XX:MetaspaceSize=<size>        åˆå§‹å…ƒç©ºé—´å¤§å°");
        System.out.println("   -XX:MaxMetaspaceSize=<size>     æœ€å¤§å…ƒç©ºé—´å¤§å°");
        System.out.println("   -XX:CompressedClassSpaceSize=<size>  å‹ç¼©ç±»ç©ºé—´å¤§å°");
        System.out.println();
    }
    
    private static long getMetaspaceUsed() {
        List<MemoryPoolMXBean> memoryPools = ManagementFactory.getMemoryPoolMXBeans();
        
        for (MemoryPoolMXBean pool : memoryPools) {
            if (pool.getName().contains("Metaspace")) {
                return pool.getUsage().getUsed();
            }
        }
        
        return 0;
    }
    
    private static String formatMemory(long bytes) {
        if (bytes < 1024) return bytes + "B";
        if (bytes < 1024 * 1024) return (bytes / 1024) + "KB";
        return (bytes / 1024 / 1024) + "MB";
    }
}

// è‡ªå®šä¹‰ç±»åŠ è½½å™¨
class CustomClassLoader extends ClassLoader {
    @Override
    public Class<?> loadClass(String name) throws ClassNotFoundException {
        // æ¨¡æ‹Ÿç±»åŠ è½½è¿‡ç¨‹
        if (name.startsWith("DynamicClass")) {
            // å®é™…åº”ç”¨ä¸­è¿™é‡Œä¼šåŠ è½½å­—èŠ‚ç 
            throw new ClassNotFoundException("æ¨¡æ‹Ÿç±»: " + name);
        }
        return super.loadClass(name);
     }
 }
```

### 5.4 æ–¹æ³•åŒºå¼‚å¸¸æƒ…å†µ

```java
// MethodAreaExceptionDemo.java - æ¼”ç¤ºæ–¹æ³•åŒºçš„å¼‚å¸¸æƒ…å†µ
import java.lang.reflect.Method;

public class MethodAreaExceptionDemo {
    public static void main(String[] args) {
        System.out.println("=== æ–¹æ³•åŒºå¼‚å¸¸æƒ…å†µæ¼”ç¤º ===\n");
        
        // æ¼”ç¤ºOutOfMemoryError: Metaspace
        demonstrateMetaspaceOOM();
        
        // æ¼”ç¤ºæ–¹æ³•åŒºå†…å­˜æ³„æ¼
        demonstrateMethodAreaMemoryLeak();
    }
    
    private static void demonstrateMetaspaceOOM() {
        System.out.println("1. å…ƒç©ºé—´OutOfMemoryErroræ¼”ç¤ºï¼š");
        
        System.out.println("   å¯èƒ½å¯¼è‡´å…ƒç©ºé—´OOMçš„æƒ…å†µï¼š");
        System.out.println("   - åŠ¨æ€ç”Ÿæˆå¤§é‡ç±»ï¼ˆå¦‚CGLibä»£ç†ï¼‰");
        System.out.println("   - å¤§é‡ä½¿ç”¨åå°„");
        System.out.println("   - é¢‘ç¹çš„ç±»åŠ è½½å’Œå¸è½½");
        System.out.println("   - å…ƒç©ºé—´å¤§å°è®¾ç½®è¿‡å°");
        
        System.out.println("\n   é¢„é˜²æªæ–½ï¼š");
        System.out.println("   - åˆç†è®¾ç½®-XX:MetaspaceSizeå’Œ-XX:MaxMetaspaceSize");
        System.out.println("   - é¿å…åŠ¨æ€ç”Ÿæˆè¿‡å¤šç±»");
        System.out.println("   - åŠæ—¶å¸è½½ä¸éœ€è¦çš„ç±»");
        System.out.println("   - ç›‘æ§å…ƒç©ºé—´ä½¿ç”¨æƒ…å†µ");
        System.out.println();
    }
    
    private static void demonstrateMethodAreaMemoryLeak() {
        System.out.println("2. æ–¹æ³•åŒºå†…å­˜æ³„æ¼æ¼”ç¤ºï¼š");
        
        System.out.println("   å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ï¼š");
        System.out.println("   - è‡ªå®šä¹‰ClassLoaderæœªæ­£ç¡®é‡Šæ”¾");
        System.out.println("   - é™æ€é›†åˆæŒæœ‰å¤§é‡å¯¹è±¡å¼•ç”¨");
        System.out.println("   - å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²è¿‡å¤š");
        
        // æ¼”ç¤ºé™æ€é›†åˆå¯¼è‡´çš„å†…å­˜æ³„æ¼
        StaticCollectionLeak.addData("æ•°æ®" + System.currentTimeMillis());
        
        System.out.println("\n   å†…å­˜æ³„æ¼æ£€æµ‹ï¼š");
        System.out.println("   - ä½¿ç”¨å†…å­˜åˆ†æå·¥å…·ï¼ˆå¦‚MATã€JProfilerï¼‰");
        System.out.println("   - ç›‘æ§å…ƒç©ºé—´ä½¿ç”¨è¶‹åŠ¿");
        System.out.println("   - åˆ†æç±»åŠ è½½å™¨çš„ç”Ÿå‘½å‘¨æœŸ");
        System.out.println();
    }
}

// æ¼”ç¤ºé™æ€é›†åˆå†…å­˜æ³„æ¼çš„ç±»
class StaticCollectionLeak {
    // é™æ€é›†åˆï¼Œç”Ÿå‘½å‘¨æœŸä¸ç±»ç›¸åŒ
    private static java.util.List<String> staticList = new java.util.ArrayList<>();
    
    public static void addData(String data) {
        staticList.add(data);
        System.out.println("   æ·»åŠ æ•°æ®åˆ°é™æ€é›†åˆï¼Œå½“å‰å¤§å°: " + staticList.size());
    }
    
    // æ³¨æ„ï¼šå¦‚æœä¸æä¾›æ¸…ç†æ–¹æ³•ï¼Œæ•°æ®å°†æ°¸è¿œä¸ä¼šè¢«å›æ”¶
    public static void clearData() {
        staticList.clear();
    }
}
```

## ç¬¬å…­éƒ¨åˆ†ï¼šç›´æ¥å†…å­˜(Direct Memory)æ·±åº¦è§£æ

### 6.1 ç›´æ¥å†…å­˜çš„è®¾è®¡åŸç†

ç›´æ¥å†…å­˜å¹¶ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä½†åœ¨JDK 1.4ä¸­å¼•å…¥çš„NIOç±»ï¼Œä½¿ç”¨äº†åŸºäºé€šé“(Channel)ä¸ç¼“å†²åŒº(Buffer)çš„I/Oæ–¹å¼ï¼Œå®ƒå¯ä»¥ä½¿ç”¨Nativeå‡½æ•°åº“ç›´æ¥åˆ†é…å †å¤–å†…å­˜ã€‚

```java
// DirectMemoryDemo.java - æ¼”ç¤ºç›´æ¥å†…å­˜çš„ä½¿ç”¨
import java.nio.ByteBuffer;
import java.lang.management.ManagementFactory;
import java.lang.management.MemoryMXBean;
import java.lang.management.MemoryUsage;

public class DirectMemoryDemo {
    public static void main(String[] args) {
        System.out.println("=== ç›´æ¥å†…å­˜æ¼”ç¤º ===\n");
        
        // æ¼”ç¤ºç›´æ¥å†…å­˜åˆ†é…
        demonstrateDirectMemoryAllocation();
        
        // æ¼”ç¤ºç›´æ¥å†…å­˜vså †å†…å­˜æ€§èƒ½
        demonstratePerformanceComparison();
        
        // æ¼”ç¤ºç›´æ¥å†…å­˜çš„ç®¡ç†
        demonstrateDirectMemoryManagement();
    }
    
    private static void demonstrateDirectMemoryAllocation() {
        System.out.println("1. ç›´æ¥å†…å­˜åˆ†é…æ¼”ç¤ºï¼š");
        
        // åˆ†é…å †å†…å­˜ç¼“å†²åŒº
        ByteBuffer heapBuffer = ByteBuffer.allocate(1024 * 1024); // 1MB
        System.out.println("   å †å†…å­˜ç¼“å†²åŒº: " + heapBuffer.getClass().getSimpleName());
        System.out.println("   æ˜¯å¦ä¸ºç›´æ¥å†…å­˜: " + heapBuffer.isDirect());
        
        // åˆ†é…ç›´æ¥å†…å­˜ç¼“å†²åŒº
        ByteBuffer directBuffer = ByteBuffer.allocateDirect(1024 * 1024); // 1MB
        System.out.println("   ç›´æ¥å†…å­˜ç¼“å†²åŒº: " + directBuffer.getClass().getSimpleName());
        System.out.println("   æ˜¯å¦ä¸ºç›´æ¥å†…å­˜: " + directBuffer.isDirect());
        
        System.out.println("\n   ç›´æ¥å†…å­˜ç‰¹ç‚¹ï¼š");
        System.out.println("   - åˆ†é…åœ¨JVMå †å¤–çš„æœ¬åœ°å†…å­˜ä¸­");
        System.out.println("   - é¿å…äº†Javaå †å’ŒNativeå †ä¹‹é—´çš„æ•°æ®å¤åˆ¶");
        System.out.println("   - ä¸å—JVMå †å¤§å°é™åˆ¶");
        System.out.println("   - åˆ†é…å’Œå›æ”¶æˆæœ¬è¾ƒé«˜");
         System.out.println();
     }
     
     private static void demonstratePerformanceComparison() {
         System.out.println("2. ç›´æ¥å†…å­˜vså †å†…å­˜æ€§èƒ½æ¯”è¾ƒï¼š");
         
         int bufferSize = 1024 * 1024; // 1MB
         int iterations = 1000;
         
         // æµ‹è¯•å †å†…å­˜æ€§èƒ½
         long heapStartTime = System.nanoTime();
         for (int i = 0; i < iterations; i++) {
             ByteBuffer heapBuffer = ByteBuffer.allocate(bufferSize);
             // æ¨¡æ‹Ÿæ•°æ®æ“ä½œ
             heapBuffer.putInt(i);
         }
         long heapEndTime = System.nanoTime();
         
         // æµ‹è¯•ç›´æ¥å†…å­˜æ€§èƒ½
         long directStartTime = System.nanoTime();
         for (int i = 0; i < iterations; i++) {
             ByteBuffer directBuffer = ByteBuffer.allocateDirect(bufferSize);
             // æ¨¡æ‹Ÿæ•°æ®æ“ä½œ
             directBuffer.putInt(i);
         }
         long directEndTime = System.nanoTime();
         
         System.out.println("   æ€§èƒ½æµ‹è¯•ç»“æœï¼ˆ" + iterations + "æ¬¡åˆ†é…ï¼‰ï¼š");
         System.out.println("     å †å†…å­˜è€—æ—¶: " + (heapEndTime - heapStartTime) / 1_000_000 + "ms");
         System.out.println("     ç›´æ¥å†…å­˜è€—æ—¶: " + (directEndTime - directStartTime) / 1_000_000 + "ms");
         
         System.out.println("\n   æ€§èƒ½ç‰¹ç‚¹ï¼š");
         System.out.println("   - ç›´æ¥å†…å­˜åˆ†é…è¾ƒæ…¢ï¼Œä½†I/Oæ“ä½œæ›´å¿«");
         System.out.println("   - é€‚åˆé¢‘ç¹I/Oæ“ä½œçš„åœºæ™¯");
         System.out.println("   - å‡å°‘äº†æ•°æ®åœ¨Javaå †å’Œæœ¬åœ°å †ä¹‹é—´çš„å¤åˆ¶");
         System.out.println();
     }
     
     private static void demonstrateDirectMemoryManagement() {
         System.out.println("3. ç›´æ¥å†…å­˜ç®¡ç†ï¼š");
         
         // è·å–ç›´æ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
         long directMemoryUsed = getDirectMemoryUsed();
         System.out.println("   å½“å‰ç›´æ¥å†…å­˜ä½¿ç”¨: " + formatMemory(directMemoryUsed));
         
         // åˆ†é…å¤§é‡ç›´æ¥å†…å­˜
         java.util.List<ByteBuffer> directBuffers = new java.util.ArrayList<>();
         
         try {
             for (int i = 0; i < 100; i++) {
                 ByteBuffer buffer = ByteBuffer.allocateDirect(1024 * 1024); // 1MB
                 directBuffers.add(buffer);
                 
                 if (i % 20 == 0) {
                     long currentUsed = getDirectMemoryUsed();
                     System.out.println("   åˆ†é…" + (i + 1) + "ä¸ªç¼“å†²åŒºå: " + formatMemory(currentUsed));
                 }
             }
         } catch (OutOfMemoryError e) {
             System.out.println("   ç›´æ¥å†…å­˜ä¸è¶³: " + e.getMessage());
         }
         
         System.out.println("\n   ç›´æ¥å†…å­˜ç®¡ç†è¦ç‚¹ï¼š");
         System.out.println("   - é€šè¿‡-XX:MaxDirectMemorySizeå‚æ•°æ§åˆ¶å¤§å°");
         System.out.println("   - ä¸å—GCç›´æ¥ç®¡ç†ï¼Œéœ€è¦æ‰‹åŠ¨é‡Šæ”¾");
         System.out.println("   - å¯é€šè¿‡System.gc()é—´æ¥è§¦å‘æ¸…ç†");
         System.out.println("   - ä½¿ç”¨sun.misc.Cleanerè¿›è¡Œè‡ªåŠ¨æ¸…ç†");
         
         // æ¸…ç†ç›´æ¥å†…å­˜
         directBuffers.clear();
         System.gc(); // å»ºè®®è¿›è¡Œåƒåœ¾å›æ”¶
         
         System.out.println();
     }
     
     private static long getDirectMemoryUsed() {
         try {
             Class<?> vmClass = Class.forName("sun.misc.VM");
             java.lang.reflect.Method method = vmClass.getMethod("maxDirectMemory");
             return (Long) method.invoke(null);
         } catch (Exception e) {
             return -1; // æ— æ³•è·å–
         }
     }
     
     private static String formatMemory(long bytes) {
         if (bytes < 0) return "æœªçŸ¥";
         if (bytes < 1024) return bytes + "B";
         if (bytes < 1024 * 1024) return (bytes / 1024) + "KB";
         return (bytes / 1024 / 1024) + "MB";
     }
 }
```

### 6.2 ç›´æ¥å†…å­˜çš„åº”ç”¨åœºæ™¯

```java
// DirectMemoryApplicationDemo.java - æ¼”ç¤ºç›´æ¥å†…å­˜çš„åº”ç”¨åœºæ™¯
import java.nio.ByteBuffer;
import java.nio.channels.FileChannel;
import java.nio.file.Paths;
import java.nio.file.StandardOpenOption;
import java.io.IOException;

public class DirectMemoryApplicationDemo {
    public static void main(String[] args) {
        System.out.println("=== ç›´æ¥å†…å­˜åº”ç”¨åœºæ™¯æ¼”ç¤º ===\n");
        
        // æ¼”ç¤ºNIOæ–‡ä»¶æ“ä½œ
        demonstrateNIOFileOperation();
        
        // æ¼”ç¤ºç½‘ç»œI/Oä¼˜åŒ–
        demonstrateNetworkIOOptimization();
        
        // æ¼”ç¤ºå¤§æ•°æ®å¤„ç†
        demonstrateBigDataProcessing();
    }
    
    private static void demonstrateNIOFileOperation() {
        System.out.println("1. NIOæ–‡ä»¶æ“ä½œä¸­çš„ç›´æ¥å†…å­˜åº”ç”¨ï¼š");
        
        try {
            // ä½¿ç”¨ç›´æ¥å†…å­˜è¿›è¡Œæ–‡ä»¶è¯»å†™
            String fileName = "test_direct_memory.txt";
            
            // å†™å…¥æ–‡ä»¶
            try (FileChannel writeChannel = FileChannel.open(
                    Paths.get(fileName), 
                    StandardOpenOption.CREATE, 
                    StandardOpenOption.WRITE)) {
                
                ByteBuffer directBuffer = ByteBuffer.allocateDirect(1024);
                String content = "ä½¿ç”¨ç›´æ¥å†…å­˜è¿›è¡Œæ–‡ä»¶I/Oæ“ä½œï¼Œé¿å…äº†æ•°æ®åœ¨Javaå †å’Œæœ¬åœ°å †ä¹‹é—´çš„å¤åˆ¶";
                directBuffer.put(content.getBytes());
                directBuffer.flip();
                
                writeChannel.write(directBuffer);
                System.out.println("   ä½¿ç”¨ç›´æ¥å†…å­˜å†™å…¥æ–‡ä»¶: " + fileName);
            }
            
            // è¯»å–æ–‡ä»¶
            try (FileChannel readChannel = FileChannel.open(
                    Paths.get(fileName), 
                    StandardOpenOption.READ)) {
                
                ByteBuffer directBuffer = ByteBuffer.allocateDirect(1024);
                readChannel.read(directBuffer);
                directBuffer.flip();
                
                byte[] data = new byte[directBuffer.remaining()];
                directBuffer.get(data);
                System.out.println("   è¯»å–å†…å®¹: " + new String(data));
            }
            
        } catch (IOException e) {
            System.out.println("   æ–‡ä»¶æ“ä½œå¼‚å¸¸: " + e.getMessage());
        }
        
        System.out.println("\n   NIOä¸­ç›´æ¥å†…å­˜çš„ä¼˜åŠ¿ï¼š");
        System.out.println("   - é›¶æ‹·è´æŠ€æœ¯ï¼Œæé«˜I/Oæ€§èƒ½");
        System.out.println("   - å‡å°‘GCå‹åŠ›");
        System.out.println("   - é€‚åˆå¤§æ–‡ä»¶å¤„ç†");
        System.out.println();
    }
    
    private static void demonstrateNetworkIOOptimization() {
        System.out.println("2. ç½‘ç»œI/Oä¼˜åŒ–ä¸­çš„ç›´æ¥å†…å­˜åº”ç”¨ï¼š");
        
        System.out.println("   ç½‘ç»œI/Oåœºæ™¯ï¼š");
        System.out.println("   - é«˜å¹¶å‘æœåŠ¡å™¨");
        System.out.println("   - å¤§æ•°æ®ä¼ è¾“");
        System.out.println("   - å®æ—¶é€šä¿¡ç³»ç»Ÿ");
        
        // æ¨¡æ‹Ÿç½‘ç»œç¼“å†²åŒº
        ByteBuffer networkBuffer = ByteBuffer.allocateDirect(8192); // 8KB
        
        System.out.println("\n   ç½‘ç»œç¼“å†²åŒºé…ç½®ï¼š");
        System.out.println("     ç¼“å†²åŒºå¤§å°: " + networkBuffer.capacity() + " bytes");
        System.out.println("     æ˜¯å¦ç›´æ¥å†…å­˜: " + networkBuffer.isDirect());
        
        System.out.println("\n   ç½‘ç»œI/Oä¼˜åŒ–æ•ˆæœï¼š");
        System.out.println("   - å‡å°‘å†…å­˜æ‹·è´æ¬¡æ•°");
        System.out.println("   - æé«˜ç½‘ç»œååé‡");
        System.out.println("   - é™ä½CPUä½¿ç”¨ç‡");
        System.out.println();
    }
    
    private static void demonstrateBigDataProcessing() {
        System.out.println("3. å¤§æ•°æ®å¤„ç†ä¸­çš„ç›´æ¥å†…å­˜åº”ç”¨ï¼š");
        
        // æ¨¡æ‹Ÿå¤§æ•°æ®ç¼“å†²åŒº
        int bufferSize = 64 * 1024 * 1024; // 64MB
        
        try {
            ByteBuffer bigDataBuffer = ByteBuffer.allocateDirect(bufferSize);
            
            System.out.println("   å¤§æ•°æ®ç¼“å†²åŒºï¼š");
            System.out.println("     ç¼“å†²åŒºå¤§å°: " + (bufferSize / 1024 / 1024) + "MB");
            System.out.println("     æ˜¯å¦ç›´æ¥å†…å­˜: " + bigDataBuffer.isDirect());
            
            // æ¨¡æ‹Ÿæ•°æ®å¤„ç†
            long startTime = System.currentTimeMillis();
            
            for (int i = 0; i < 1000000; i++) {
                bigDataBuffer.putInt(i);
                if (bigDataBuffer.remaining() < 4) {
                    bigDataBuffer.clear(); // é‡ç½®ç¼“å†²åŒº
                }
            }
            
            long endTime = System.currentTimeMillis();
            
            System.out.println("\n   å¤„ç†æ€§èƒ½ï¼š");
            System.out.println("     å¤„ç†100ä¸‡ä¸ªæ•´æ•°è€—æ—¶: " + (endTime - startTime) + "ms");
            
        } catch (OutOfMemoryError e) {
            System.out.println("   ç›´æ¥å†…å­˜ä¸è¶³ï¼Œæ— æ³•åˆ†é…64MBç¼“å†²åŒº");
        }
        
        System.out.println("\n   å¤§æ•°æ®å¤„ç†ä¼˜åŠ¿ï¼š");
        System.out.println("   - ä¸å ç”¨JVMå †ç©ºé—´");
        System.out.println("   - é¿å…å¤§å¯¹è±¡å¯¼è‡´çš„GCé—®é¢˜");
        System.out.println("   - æé«˜å†…å­˜ä½¿ç”¨æ•ˆç‡");
         System.out.println();
     }
  }
```

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šJVMå†…å­˜æ•°æ®åŒºç»¼åˆå®æˆ˜

### 7.1 å†…å­˜ä½¿ç”¨æ¨¡å¼åˆ†æ

```java
// MemoryPatternAnalysisDemo.java - ç»¼åˆåˆ†æJVMå†…å­˜ä½¿ç”¨æ¨¡å¼
import java.lang.management.*;
import java.util.*;
import java.util.concurrent.*;

public class MemoryPatternAnalysisDemo {
    public static void main(String[] args) {
        System.out.println("=== JVMå†…å­˜ä½¿ç”¨æ¨¡å¼ç»¼åˆåˆ†æ ===\n");
        
        // åˆ†æä¸åŒå†…å­˜åŒºåŸŸçš„ä½¿ç”¨æ¨¡å¼
        analyzeMemoryUsagePatterns();
        
        // æ¼”ç¤ºå†…å­˜åŒºåŸŸä¹‹é—´çš„äº¤äº’
        demonstrateMemoryInteraction();
        
        // æ€§èƒ½ä¼˜åŒ–å»ºè®®
        provideOptimizationSuggestions();
    }
    
    private static void analyzeMemoryUsagePatterns() {
        System.out.println("1. å†…å­˜ä½¿ç”¨æ¨¡å¼åˆ†æï¼š");
        
        // è·å–å†…å­˜ç®¡ç†ç›¸å…³çš„MXBean
        MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
        List<MemoryPoolMXBean> memoryPools = ManagementFactory.getMemoryPoolMXBeans();
        
        System.out.println("   å½“å‰å†…å­˜ä½¿ç”¨æƒ…å†µï¼š");
        
        // åˆ†æå †å†…å­˜ä½¿ç”¨
        MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
        System.out.println("     å †å†…å­˜: " + formatMemoryUsage(heapUsage));
        
        // åˆ†æéå †å†…å­˜ä½¿ç”¨
        MemoryUsage nonHeapUsage = memoryBean.getNonHeapMemoryUsage();
        System.out.println("     éå †å†…å­˜: " + formatMemoryUsage(nonHeapUsage));
        
        // è¯¦ç»†åˆ†æå„å†…å­˜æ± 
        System.out.println("\n   å„å†…å­˜æ± è¯¦ç»†åˆ†æï¼š");
        for (MemoryPoolMXBean pool : memoryPools) {
            MemoryUsage usage = pool.getUsage();
            String poolType = pool.getType() == MemoryType.HEAP ? "å †" : "éå †";
            
            System.out.println("     " + pool.getName() + " (" + poolType + "):");
            System.out.println("       ä½¿ç”¨ç‡: " + calculateUsagePercentage(usage) + "%");
            System.out.println("       è¯¦æƒ…: " + formatMemoryUsage(usage));
        }
        
        System.out.println();
    }
    
    private static void demonstrateMemoryInteraction() {
        System.out.println("2. å†…å­˜åŒºåŸŸäº¤äº’æ¼”ç¤ºï¼š");
        
        // æ¼”ç¤ºå¯¹è±¡ä»åˆ›å»ºåˆ°å›æ”¶çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
        demonstrateObjectLifecycle();
        
        // æ¼”ç¤ºæ–¹æ³•è°ƒç”¨å¯¹å„å†…å­˜åŒºåŸŸçš„å½±å“
        demonstrateMethodCallImpact();
        
        // æ¼”ç¤ºç±»åŠ è½½å¯¹å†…å­˜çš„å½±å“
        demonstrateClassLoadingImpact();
    }
    
    private static void demonstrateObjectLifecycle() {
        System.out.println("   å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå†…å­˜äº¤äº’ï¼š");
        
        // è®°å½•åˆå§‹çŠ¶æ€
        long initialHeapUsed = getHeapUsed();
        
        System.out.println("     1. å¯¹è±¡åˆ›å»ºé˜¶æ®µï¼š");
        List<String> objects = new ArrayList<>();
        
        for (int i = 0; i < 10000; i++) {
            // å¯¹è±¡åœ¨å †ä¸­åˆ†é…
            String obj = new String("å¯¹è±¡_" + i);
            objects.add(obj);
        }
        
        long afterCreationHeapUsed = getHeapUsed();
        System.out.println("       å †å†…å­˜å¢é•¿: " + 
                         formatMemory(afterCreationHeapUsed - initialHeapUsed));
        
        System.out.println("     2. å¯¹è±¡å¼•ç”¨é˜¶æ®µï¼š");
        System.out.println("       å¯¹è±¡å¼•ç”¨å­˜å‚¨åœ¨è™šæ‹Ÿæœºæ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­");
        System.out.println("       å¯¹è±¡æ•°æ®å­˜å‚¨åœ¨å †å†…å­˜ä¸­");
        
        System.out.println("     3. å¯¹è±¡å›æ”¶é˜¶æ®µï¼š");
        objects.clear(); // æ¸…é™¤å¼•ç”¨
        System.gc(); // å»ºè®®åƒåœ¾å›æ”¶
        
        try {
            Thread.sleep(100); // ç­‰å¾…GCå®Œæˆ
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        long afterGCHeapUsed = getHeapUsed();
        System.out.println("       GCåå †å†…å­˜: " + formatMemory(afterGCHeapUsed));
        
        System.out.println();
    }
    
    private static void demonstrateMethodCallImpact() {
        System.out.println("   æ–¹æ³•è°ƒç”¨å†…å­˜äº¤äº’ï¼š");
        
        System.out.println("     æ–¹æ³•è°ƒç”¨æ¶‰åŠçš„å†…å­˜åŒºåŸŸï¼š");
        System.out.println("     - PCå¯„å­˜å™¨ï¼šå­˜å‚¨å½“å‰æ‰§è¡ŒæŒ‡ä»¤åœ°å€");
        System.out.println("     - è™šæ‹Ÿæœºæ ˆï¼šåˆ›å»ºæ ˆå¸§ï¼Œå­˜å‚¨å±€éƒ¨å˜é‡å’Œæ“ä½œæ•°æ ˆ");
        System.out.println("     - æ–¹æ³•åŒºï¼šå­˜å‚¨æ–¹æ³•å­—èŠ‚ç å’Œç±»ä¿¡æ¯");
        System.out.println("     - å †ï¼šå­˜å‚¨æ–¹æ³•ä¸­åˆ›å»ºçš„å¯¹è±¡");
        
        // æ¼”ç¤ºé€’å½’è°ƒç”¨å¯¹æ ˆçš„å½±å“
        try {
            recursiveMethod(0, 1000);
        } catch (StackOverflowError e) {
            System.out.println("     é€’å½’è¿‡æ·±å¯¼è‡´æ ˆæº¢å‡ºï¼ˆå·²æ•è·ï¼‰");
        }
        
        System.out.println();
    }
    
    private static void recursiveMethod(int current, int max) {
        if (current >= max) return;
        
        // æ¯æ¬¡é€’å½’è°ƒç”¨éƒ½ä¼šåœ¨è™šæ‹Ÿæœºæ ˆä¸­åˆ›å»ºæ–°çš„æ ˆå¸§
        String localVar = "é€’å½’å±‚çº§_" + current;
        recursiveMethod(current + 1, max);
    }
    
    private static void demonstrateClassLoadingImpact() {
        System.out.println("   ç±»åŠ è½½å†…å­˜äº¤äº’ï¼š");
        
        long metaspaceBefore = getMetaspaceUsed();
        
        System.out.println("     ç±»åŠ è½½æ¶‰åŠçš„å†…å­˜åŒºåŸŸï¼š");
        System.out.println("     - å…ƒç©ºé—´ï¼šå­˜å‚¨ç±»çš„å…ƒæ•°æ®ä¿¡æ¯");
        System.out.println("     - å †ï¼šå­˜å‚¨Classå¯¹è±¡å’Œé™æ€å˜é‡");
        System.out.println("     - è¿è¡Œæ—¶å¸¸é‡æ± ï¼šå­˜å‚¨å­—ç¬¦ä¸²å­—é¢é‡å’Œç¬¦å·å¼•ç”¨");
        
        // è§¦å‘ç±»åŠ è½½
        try {
            Class.forName("java.util.concurrent.ConcurrentHashMap");
            Class.forName("java.util.concurrent.ThreadPoolExecutor");
        } catch (ClassNotFoundException e) {
            // å¿½ç•¥
        }
        
        long metaspaceAfter = getMetaspaceUsed();
        if (metaspaceAfter > metaspaceBefore) {
            System.out.println("     å…ƒç©ºé—´ä½¿ç”¨å¢é•¿: " + 
                             formatMemory(metaspaceAfter - metaspaceBefore));
        }
        
        System.out.println();
    }
    
    private static void provideOptimizationSuggestions() {
        System.out.println("3. å†…å­˜ä¼˜åŒ–å»ºè®®ï¼š");
        
        System.out.println("   å †å†…å­˜ä¼˜åŒ–ï¼š");
        System.out.println("   - åˆç†è®¾ç½®-Xmså’Œ-Xmxå‚æ•°");
        System.out.println("   - è°ƒæ•´å¹´è½»ä»£å’Œè€å¹´ä»£æ¯”ä¾‹");
        System.out.println("   - é€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†å™¨");
        System.out.println("   - é¿å…åˆ›å»ºä¸å¿…è¦çš„å¤§å¯¹è±¡");
        
        System.out.println("\n   æ ˆå†…å­˜ä¼˜åŒ–ï¼š");
        System.out.println("   - é¿å…è¿‡æ·±çš„é€’å½’è°ƒç”¨");
        System.out.println("   - åˆç†è®¾ç½®-Xsså‚æ•°");
        System.out.println("   - å‡å°‘å±€éƒ¨å˜é‡çš„ä½¿ç”¨");
        
        System.out.println("\n   æ–¹æ³•åŒºä¼˜åŒ–ï¼š");
        System.out.println("   - åˆç†è®¾ç½®å…ƒç©ºé—´å¤§å°");
        System.out.println("   - é¿å…åŠ¨æ€ç”Ÿæˆè¿‡å¤šç±»");
        System.out.println("   - åŠæ—¶å¸è½½ä¸éœ€è¦çš„ç±»");
        
        System.out.println("\n   ç›´æ¥å†…å­˜ä¼˜åŒ–ï¼š");
        System.out.println("   - åˆç†ä½¿ç”¨NIOå’Œç›´æ¥å†…å­˜");
        System.out.println("   - è®¾ç½®åˆé€‚çš„-XX:MaxDirectMemorySize");
        System.out.println("   - åŠæ—¶é‡Šæ”¾ç›´æ¥å†…å­˜ç¼“å†²åŒº");
        
        System.out.println();
    }
    
    // è¾…åŠ©æ–¹æ³•
    private static String formatMemoryUsage(MemoryUsage usage) {
        return String.format("%s / %s", 
                           formatMemory(usage.getUsed()), 
                           formatMemory(usage.getMax()));
    }
    
    private static double calculateUsagePercentage(MemoryUsage usage) {
        if (usage.getMax() == -1) return 0.0;
        return (double) usage.getUsed() / usage.getMax() * 100;
    }
    
    private static long getHeapUsed() {
        return ManagementFactory.getMemoryMXBean().getHeapMemoryUsage().getUsed();
    }
    
    private static long getMetaspaceUsed() {
        List<MemoryPoolMXBean> pools = ManagementFactory.getMemoryPoolMXBeans();
        for (MemoryPoolMXBean pool : pools) {
            if (pool.getName().contains("Metaspace")) {
                return pool.getUsage().getUsed();
            }
        }
        return 0;
    }
    
    private static String formatMemory(long bytes) {
         if (bytes < 1024) return bytes + "B";
         if (bytes < 1024 * 1024) return String.format("%.1fKB", bytes / 1024.0);
         if (bytes < 1024 * 1024 * 1024) return String.format("%.1fMB", bytes / 1024.0 / 1024.0);
         return String.format("%.1fGB", bytes / 1024.0 / 1024.0 / 1024.0);
     }
 }
```

## ç¬¬å…«éƒ¨åˆ†ï¼šOpenJDKæºç æ·±åº¦è§£æ

### 8.1 å†…å­˜ç®¡ç†æ ¸å¿ƒæºç åˆ†æ

åŸºäºOpenJDKæºç ï¼Œæˆ‘ä»¬æ·±å…¥åˆ†æJVMå†…å­˜æ•°æ®åŒºçš„å®ç°æœºåˆ¶ï¼š

#### 8.1.1 å †å†…å­˜å®ç°ï¼ˆuniverse.cppï¼‰

```cpp
// OpenJDKæºç ï¼šsrc/hotspot/share/memory/universe.cpp
// å †å†…å­˜åˆå§‹åŒ–çš„æ ¸å¿ƒå®ç°

void Universe::initialize_heap() {
  // åˆ›å»ºå †å†…å­˜å®ä¾‹
  _heap = create_heap();
  
  // åˆå§‹åŒ–å †å†…å­˜åŒºåŸŸ
  _heap->initialize();
  
  // è®¾ç½®å †å†…å­˜è¾¹ç•Œ
  MemRegion reserved_region = _heap->reserved_region();
  _heap_base = (address)reserved_region.start();
  _heap_top  = (address)reserved_region.end();
}

// å¯¹è±¡åˆ†é…çš„æ ¸å¿ƒé€»è¾‘
oop CollectedHeap::allocate_new_tlab(size_t size) {
  // åœ¨TLABï¼ˆThread Local Allocation Bufferï¼‰ä¸­åˆ†é…
  HeapWord* obj = allocate(size, false);
  if (obj != NULL) {
    return (oop)obj;
  }
  
  // TLABåˆ†é…å¤±è´¥ï¼Œå°è¯•åœ¨å…±äº«å †ä¸­åˆ†é…
  return slow_path_allocation(size);
}
```

**å…³é”®è®¾è®¡åŸç†ï¼š**
- **åˆ†ä»£æ”¶é›†**ï¼šå¹´è½»ä»£å’Œè€å¹´ä»£çš„ç‰©ç†åˆ†ç¦»
- **TLABæœºåˆ¶**ï¼šçº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²åŒºï¼Œå‡å°‘åŒæ­¥å¼€é”€
- **æŒ‡é’ˆå‹ç¼©**ï¼šåœ¨64ä½å¹³å°ä¸Šå‹ç¼©å¯¹è±¡æŒ‡é’ˆï¼ŒèŠ‚çœå†…å­˜

#### 8.1.2 è™šæ‹Ÿæœºæ ˆå®ç°ï¼ˆthread.cppï¼‰

```cpp
// OpenJDKæºç ï¼šsrc/hotspot/share/runtime/thread.cpp
// è™šæ‹Ÿæœºæ ˆçš„åˆ›å»ºå’Œç®¡ç†

void JavaThread::create_stack_guard_pages() {
  // è®¡ç®—æ ˆå¤§å°
  size_t stack_size = _stack_size;
  
  // åˆ›å»ºæ ˆä¿æŠ¤é¡µ
  address stack_base = _stack_base;
  address stack_end = stack_base - stack_size;
  
  // è®¾ç½®æ ˆæº¢å‡ºæ£€æµ‹
  _stack_overflow_limit = stack_end + 
                         (StackShadowPages + StackRedPages + StackYellowPages) * os::vm_page_size();
}

// æ ˆå¸§çš„åˆ›å»º
frame JavaThread::last_frame() {
  // è·å–å½“å‰æ ˆé¡¶
  intptr_t* sp = last_Java_sp();
  address pc = last_Java_pc();
  
  // åˆ›å»ºæ ˆå¸§å¯¹è±¡
  return frame(sp, pc);
}
```

**å…³é”®è®¾è®¡åŸç†ï¼š**
- **æ ˆä¿æŠ¤æœºåˆ¶**ï¼šé€šè¿‡ä¿æŠ¤é¡µæ£€æµ‹æ ˆæº¢å‡º
- **æ ˆå¸§ç»“æ„**ï¼šå±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ç­‰
- **æ ˆå¤§å°é…ç½®**ï¼šå¯é€šè¿‡-Xsså‚æ•°è°ƒæ•´

#### 8.1.3 æ–¹æ³•åŒºå®ç°ï¼ˆmetaspace.cppï¼‰

```cpp
// OpenJDKæºç ï¼šsrc/hotspot/share/memory/metaspace.cpp
// å…ƒç©ºé—´çš„å®ç°æœºåˆ¶

class Metaspace : public CHeapObj<mtClass> {
private:
  // å…ƒç©ºé—´å†…å­˜ç®¡ç†å™¨
  MetaspaceManager* _manager;
  
  // ç±»åŠ è½½å™¨æ•°æ®
  ClassLoaderData* _loader_data;
  
public:
  // åˆ†é…å…ƒæ•°æ®å†…å­˜
  MetaWord* allocate(size_t word_size, MetaspaceObj::Type type) {
    // å°è¯•ä»å½“å‰å—åˆ†é…
    MetaWord* result = _manager->allocate(word_size);
    
    if (result == NULL) {
      // å½“å‰å—ä¸è¶³ï¼Œç”³è¯·æ–°å—
      result = expand_and_allocate(word_size, type);
    }
    
    return result;
  }
  
  // æ‰©å±•å…ƒç©ºé—´
  MetaWord* expand_and_allocate(size_t word_size, MetaspaceObj::Type type) {
    // è®¡ç®—éœ€è¦çš„å—å¤§å°
    size_t delta_bytes = MetaspaceGC::delta_capacity_until_GC(word_size * BytesPerWord);
    
    // æ‰©å±•å…ƒç©ºé—´å®¹é‡
    bool succeeded = _manager->expand_by(delta_bytes);
    
    if (succeeded) {
      return _manager->allocate(word_size);
    }
    
    return NULL;
  }
};
```

**å…³é”®è®¾è®¡åŸç†ï¼š**
- **æœ¬åœ°å†…å­˜ç®¡ç†**ï¼šä½¿ç”¨æ“ä½œç³»ç»Ÿå†…å­˜ï¼Œä¸å—å †å¤§å°é™åˆ¶
- **ç±»åŠ è½½å™¨éš”ç¦»**ï¼šæ¯ä¸ªç±»åŠ è½½å™¨æœ‰ç‹¬ç«‹çš„å…ƒç©ºé—´
- **åŠ¨æ€æ‰©å±•**ï¼šæ ¹æ®éœ€è¦åŠ¨æ€åˆ†é…å’Œå›æ”¶å†…å­˜

#### 8.1.4 ç¨‹åºè®¡æ•°å™¨å®ç°ï¼ˆframe.cppï¼‰

```cpp
// OpenJDKæºç ï¼šsrc/hotspot/share/runtime/frame.cpp
// ç¨‹åºè®¡æ•°å™¨çš„å®ç°

class frame {
private:
  intptr_t* _sp; // æ ˆæŒ‡é’ˆ
  address   _pc; // ç¨‹åºè®¡æ•°å™¨
  
public:
  // è·å–å½“å‰æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤
  address pc() const { return _pc; }
  
  // è®¾ç½®ç¨‹åºè®¡æ•°å™¨
  void set_pc(address newpc) { _pc = newpc; }
  
  // è·å–ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€
  address next_pc() const {
    return _pc + Bytecodes::length_at(_pc);
  }
};

// å­—èŠ‚ç è§£é‡Šå™¨ä¸­çš„PCæ›´æ–°
void BytecodeInterpreter::run(interpreterState istate) {
  // è·å–å½“å‰PC
  address pc = istate->_pc;
  
  // æ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤
  Bytecodes::Code opcode = Bytecodes::code_at(pc);
  
  switch (opcode) {
    case Bytecodes::_iload:
      // æ‰§è¡ŒiloadæŒ‡ä»¤
      // ...
      // æ›´æ–°PCåˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤
      istate->_pc = pc + 2;
      break;
      
    case Bytecodes::_goto:
      // æ‰§è¡ŒgotoæŒ‡ä»¤
      int16_t offset = Bytes::get_Java_u2(pc + 1);
      istate->_pc = pc + offset;
      break;
  }
}
```

**å…³é”®è®¾è®¡åŸç†ï¼š**
- **æŒ‡ä»¤è·Ÿè¸ª**ï¼šç²¾ç¡®è®°å½•å½“å‰æ‰§è¡Œä½ç½®
- **åˆ†æ”¯å¤„ç†**ï¼šæ”¯æŒæ¡ä»¶è·³è½¬å’Œæ— æ¡ä»¶è·³è½¬
- **å¼‚å¸¸æ¢å¤**ï¼šå¼‚å¸¸å¤„ç†æ—¶çš„PCæ¢å¤æœºåˆ¶

### 8.2 å†…å­˜åˆ†é…ç®—æ³•åˆ†æ

#### 8.2.1 TLABåˆ†é…ç®—æ³•

```cpp
// OpenJDKæºç ï¼šsrc/hotspot/share/gc/shared/threadLocalAllocBuffer.cpp

class ThreadLocalAllocBuffer {
private:
  HeapWord* _start;    // TLABèµ·å§‹åœ°å€
  HeapWord* _top;      // å½“å‰åˆ†é…ä½ç½®
  HeapWord* _end;      // TLABç»“æŸåœ°å€
  
public:
  // å¿«é€Ÿåˆ†é…
  inline HeapWord* allocate(size_t size) {
    HeapWord* obj = _top;
    if (obj + size <= _end) {
      _top = obj + size;
      return obj;
    }
    return NULL; // åˆ†é…å¤±è´¥
  }
  
  // TLABé‡æ–°å¡«å……
  void make_parsable(bool retire_tlabs) {
    if (retire_tlabs) {
      // é€€ä¼‘å½“å‰TLAB
      retire();
      
      // ç”³è¯·æ–°çš„TLAB
      resize();
    }
  }
};
```

#### 8.2.2 å¤§å¯¹è±¡åˆ†é…ç­–ç•¥

```cpp
// å¤§å¯¹è±¡ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…
oop CollectedHeap::large_object_allocation(size_t size) {
  // æ£€æŸ¥æ˜¯å¦ä¸ºå¤§å¯¹è±¡
  if (size >= _large_object_threshold) {
    // ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…
    return old_generation()->allocate(size);
  }
  
  // æ™®é€šå¯¹è±¡åœ¨å¹´è½»ä»£åˆ†é…
  return young_generation()->allocate(size);
}
```

## ç¬¬ä¹éƒ¨åˆ†ï¼šè¯¾åç»ƒä¹ ä¸æ€è€ƒé¢˜

### 9.1 å®æˆ˜ç¼–ç¨‹é¢˜

**é¢˜ç›®1ï¼šå†…å­˜ä½¿ç”¨ç›‘æ§å·¥å…·**

ç¼–å†™ä¸€ä¸ªJavaç¨‹åºï¼Œå®æ—¶ç›‘æ§JVMå„å†…å­˜åŒºåŸŸçš„ä½¿ç”¨æƒ…å†µï¼Œå¹¶åœ¨å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼æ—¶å‘å‡ºè­¦å‘Šã€‚

```java
// MemoryMonitor.java - å†…å­˜ç›‘æ§å·¥å…·
import java.lang.management.*;
import java.util.*;
import java.util.concurrent.*;

public class MemoryMonitor {
    private static final double WARNING_THRESHOLD = 0.8; // 80%è­¦å‘Šé˜ˆå€¼
    private static final double CRITICAL_THRESHOLD = 0.9; // 90%ä¸¥é‡é˜ˆå€¼
    
    public static void main(String[] args) {
        ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
        
        // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡å†…å­˜ä½¿ç”¨æƒ…å†µ
        executor.scheduleAtFixedRate(() -> {
            checkMemoryUsage();
        }, 0, 5, TimeUnit.SECONDS);
        
        // è¿è¡Œ60ç§’ååœæ­¢
        try {
            Thread.sleep(60000);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        executor.shutdown();
    }
    
    private static void checkMemoryUsage() {
        // TODO: å®ç°å†…å­˜ç›‘æ§é€»è¾‘
        // 1. è·å–å„å†…å­˜æ± çš„ä½¿ç”¨æƒ…å†µ
        // 2. è®¡ç®—ä½¿ç”¨ç‡
        // 3. æ ¹æ®é˜ˆå€¼å‘å‡ºè­¦å‘Š
        // 4. è®°å½•å†å²æ•°æ®
    }
}
```

**é¢˜ç›®2ï¼šå†…å­˜æ³„æ¼æ£€æµ‹å™¨**

è®¾è®¡ä¸€ä¸ªç®€å•çš„å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·ï¼Œèƒ½å¤Ÿè¯†åˆ«å¯èƒ½çš„å†…å­˜æ³„æ¼æ¨¡å¼ã€‚

```java
// MemoryLeakDetector.java - å†…å­˜æ³„æ¼æ£€æµ‹å™¨
public class MemoryLeakDetector {
    // TODO: å®ç°å†…å­˜æ³„æ¼æ£€æµ‹é€»è¾‘
    // 1. ç›‘æ§å¯¹è±¡åˆ›å»ºå’Œé”€æ¯
    // 2. è¯†åˆ«é•¿æœŸå­˜åœ¨çš„å¯¹è±¡
    // 3. åˆ†æå¯¹è±¡å¼•ç”¨å…³ç³»
    // 4. ç”Ÿæˆæ³„æ¼æŠ¥å‘Š
}
```

### 9.2 ç†è®ºåˆ†æé¢˜

**é¢˜ç›®3ï¼šå†…å­˜åŒºåŸŸäº¤äº’åˆ†æ**

åˆ†æä»¥ä¸‹ä»£ç åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ¶‰åŠçš„JVMå†…å­˜åŒºåŸŸï¼Œå¹¶è¯´æ˜å„åŒºåŸŸçš„ä½œç”¨ï¼š

```java
public class MemoryInteractionExample {
    private static String staticField = "é™æ€å­—æ®µ";
    private String instanceField = "å®ä¾‹å­—æ®µ";
    
    public void methodExample() {
        String localVar = "å±€éƒ¨å˜é‡";
        String internedString = localVar.intern();
        
        List<String> list = new ArrayList<>();
        list.add(staticField);
        list.add(instanceField);
        list.add(localVar);
        
        recursiveMethod(5);
    }
    
    private void recursiveMethod(int depth) {
        if (depth <= 0) return;
        
        String temp = "é€’å½’_" + depth;
        recursiveMethod(depth - 1);
    }
}
```

**åˆ†æè¦ç‚¹ï¼š**
1. å„å˜é‡å­˜å‚¨åœ¨å“ªä¸ªå†…å­˜åŒºåŸŸï¼Ÿ
2. æ–¹æ³•è°ƒç”¨å¦‚ä½•å½±å“è™šæ‹Ÿæœºæ ˆï¼Ÿ
3. å­—ç¬¦ä¸²å¸¸é‡æ± çš„ä½œç”¨æœºåˆ¶ï¼Ÿ
4. å¯¹è±¡åˆ›å»ºå¯¹å †å†…å­˜çš„å½±å“ï¼Ÿ

**é¢˜ç›®4ï¼šå†…å­˜å‚æ•°ä¼˜åŒ–**

é’ˆå¯¹ä»¥ä¸‹åº”ç”¨åœºæ™¯ï¼Œè®¾è®¡åˆé€‚çš„JVMå†…å­˜å‚æ•°é…ç½®ï¼š

1. **Webåº”ç”¨æœåŠ¡å™¨**ï¼šé«˜å¹¶å‘ã€å¤§é‡çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡
2. **å¤§æ•°æ®å¤„ç†**ï¼šå¤„ç†å¤§æ–‡ä»¶ã€éœ€è¦å¤§é‡å†…å­˜
3. **å¾®æœåŠ¡åº”ç”¨**ï¼šå†…å­˜å—é™ã€å¯åŠ¨é€Ÿåº¦è¦æ±‚é«˜
4. **æ‰¹å¤„ç†ä»»åŠ¡**ï¼šé•¿æ—¶é—´è¿è¡Œã€ç¨³å®šçš„å†…å­˜ä½¿ç”¨

### 9.3 æ€§èƒ½ä¼˜åŒ–é¢˜

**é¢˜ç›®5ï¼šå†…å­˜ä½¿ç”¨ä¼˜åŒ–**

ä¼˜åŒ–ä»¥ä¸‹ä»£ç çš„å†…å­˜ä½¿ç”¨æ•ˆç‡ï¼š

```java
// ä¼˜åŒ–å‰çš„ä»£ç 
public class MemoryInefficient {
    public List<String> processData(List<String> input) {
        List<String> result = new ArrayList<>();
        
        for (String item : input) {
            String processed = item.toUpperCase().trim();
            if (processed.length() > 0) {
                result.add(new String(processed)); // é—®é¢˜ï¼šä¸å¿…è¦çš„Stringåˆ›å»º
            }
        }
        
        return result;
    }
    
    public Map<String, Integer> countWords(String text) {
        Map<String, Integer> counts = new HashMap<>();
        String[] words = text.split(" ");
        
        for (String word : words) {
            String key = new String(word.toLowerCase()); // é—®é¢˜ï¼šä¸å¿…è¦çš„Stringåˆ›å»º
            counts.put(key, counts.getOrDefault(key, 0) + 1);
        }
        
        return counts;
    }
}
```

**ä¼˜åŒ–æ–¹å‘ï¼š**
1. å‡å°‘ä¸å¿…è¦çš„å¯¹è±¡åˆ›å»º
2. å¤ç”¨å¯¹è±¡å’Œæ•°æ®ç»“æ„
3. ä½¿ç”¨åˆé€‚çš„é›†åˆåˆå§‹å®¹é‡
4. è€ƒè™‘ä½¿ç”¨StringBuilderç­‰é«˜æ•ˆå·¥å…·

### 9.4 æ ‡å‡†ç­”æ¡ˆä¸è§£æ

#### é¢˜ç›®1ç­”æ¡ˆï¼šå†…å­˜ç›‘æ§å·¥å…·

```java
public class MemoryMonitor {
    private static final double WARNING_THRESHOLD = 0.8;
    private static final double CRITICAL_THRESHOLD = 0.9;
    
    private static void checkMemoryUsage() {
        List<MemoryPoolMXBean> pools = ManagementFactory.getMemoryPoolMXBeans();
        
        for (MemoryPoolMXBean pool : pools) {
            MemoryUsage usage = pool.getUsage();
            if (usage.getMax() == -1) continue; // è·³è¿‡æ— é™åˆ¶çš„å†…å­˜æ± 
            
            double usageRatio = (double) usage.getUsed() / usage.getMax();
            
            if (usageRatio >= CRITICAL_THRESHOLD) {
                System.err.println("[CRITICAL] " + pool.getName() + 
                                 " ä½¿ç”¨ç‡: " + String.format("%.1f%%", usageRatio * 100));
            } else if (usageRatio >= WARNING_THRESHOLD) {
                System.out.println("[WARNING] " + pool.getName() + 
                                 " ä½¿ç”¨ç‡: " + String.format("%.1f%%", usageRatio * 100));
            }
        }
    }
}
```

#### é¢˜ç›®3ç­”æ¡ˆï¼šå†…å­˜åŒºåŸŸäº¤äº’åˆ†æ

1. **é™æ€å­—æ®µ**ï¼šå­˜å‚¨åœ¨æ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´ï¼‰
2. **å®ä¾‹å­—æ®µ**ï¼šå­˜å‚¨åœ¨å †å†…å­˜ä¸­çš„å¯¹è±¡å®ä¾‹å†…
3. **å±€éƒ¨å˜é‡**ï¼šå­˜å‚¨åœ¨è™šæ‹Ÿæœºæ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­
4. **å­—ç¬¦ä¸²å­—é¢é‡**ï¼šå­˜å‚¨åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­
5. **æ–¹æ³•è°ƒç”¨**ï¼šåœ¨è™šæ‹Ÿæœºæ ˆä¸­åˆ›å»ºæ ˆå¸§
6. **å¯¹è±¡åˆ›å»º**ï¼šåœ¨å †å†…å­˜ä¸­åˆ†é…ç©ºé—´

#### é¢˜ç›®5ç­”æ¡ˆï¼šå†…å­˜ä½¿ç”¨ä¼˜åŒ–

```java
// ä¼˜åŒ–åçš„ä»£ç 
public class MemoryEfficient {
    public List<String> processData(List<String> input) {
        List<String> result = new ArrayList<>(input.size()); // é¢„è®¾å®¹é‡
        
        for (String item : input) {
            String processed = item.toUpperCase().trim();
            if (processed.length() > 0) {
                result.add(processed); // ç›´æ¥ä½¿ç”¨ï¼Œé¿å…new String()
            }
        }
        
        return result;
    }
    
    public Map<String, Integer> countWords(String text) {
        String[] words = text.split(" ");
        Map<String, Integer> counts = new HashMap<>(words.length); // é¢„è®¾å®¹é‡
        
        for (String word : words) {
            String key = word.toLowerCase(); // ç›´æ¥ä½¿ç”¨è¿”å›å€¼
            counts.put(key, counts.getOrDefault(key, 0) + 1);
        }
        
        return counts;
    }
}
```

## è¯¾ç¨‹æ€»ç»“

### æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾

1. **JVMè¿è¡Œæ—¶æ•°æ®åŒºç»“æ„**
   - çº¿ç¨‹å…±äº«ï¼šæ–¹æ³•åŒºã€å †
   - çº¿ç¨‹ç§æœ‰ï¼šç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆ
   - ç‰¹æ®ŠåŒºåŸŸï¼šç›´æ¥å†…å­˜

2. **å„å†…å­˜åŒºåŸŸçš„è®¾è®¡åŸç†**
   - åŸºäºOracle JVM Specificationçš„æƒå¨è®¾è®¡
   - OpenJDKæºç å®ç°çš„æŠ€æœ¯ç»†èŠ‚
   - å†…å­˜ç®¡ç†çš„æ ¸å¿ƒç®—æ³•

3. **å®é™…åº”ç”¨ä¸ä¼˜åŒ–**
   - å†…å­˜å‚æ•°è°ƒä¼˜ç­–ç•¥
   - æ€§èƒ½ç›‘æ§å’Œé—®é¢˜è¯Šæ–­
   - å†…å­˜æ³„æ¼çš„é¢„é˜²å’Œæ£€æµ‹

### æŠ€æœ¯æ·±åº¦ä¸å¹¿åº¦

æœ¬è¯¾ç¨‹ä»ç†è®ºåŸºç¡€åˆ°å®è·µåº”ç”¨ï¼Œä»è§„èŒƒè§£è¯»åˆ°æºç åˆ†æï¼Œå…¨é¢è¦†ç›–äº†JVMå†…å­˜æ•°æ®åŒºçš„æ ¸å¿ƒçŸ¥è¯†ã€‚é€šè¿‡å¤§é‡çš„ä»£ç ç¤ºä¾‹å’Œå®æˆ˜æ¼”ç»ƒï¼Œå¸®åŠ©å­¦å‘˜æ·±å…¥ç†è§£JVMå†…å­˜ç®¡ç†çš„ç²¾é«“ã€‚

### ä¸‹èŠ‚é¢„å‘Š

ä¸‹ä¸€è¯¾æˆ‘ä»¬å°†æ·±å…¥æ¢è®¨**åƒåœ¾å›æ”¶ç®—æ³•ä¸æ”¶é›†å™¨å®æˆ˜**ï¼ŒåŒ…æ‹¬ï¼š
- åƒåœ¾å›æ”¶ç®—æ³•åŸç†ï¼ˆæ ‡è®°-æ¸…é™¤ã€å¤åˆ¶ã€æ ‡è®°-æ•´ç†ï¼‰
- åˆ†ä»£æ”¶é›†ç†è®ºä¸å®è·µ
- ä¸»æµåƒåœ¾æ”¶é›†å™¨è¯¦è§£ï¼ˆSerialã€Parallelã€CMSã€G1ã€ZGCï¼‰
- GCè°ƒä¼˜å®æˆ˜ä¸é—®é¢˜æ’æŸ¥

æ•¬è¯·æœŸå¾…ï¼