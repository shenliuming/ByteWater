<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL åŒå†™ç¼“å†²(DWB)æœºåˆ¶åŠ¨ç”»æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .controls {
            text-align: center;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .scenario-selector {
            text-align: center;
            margin-bottom: 30px;
        }

        .scenario-btn {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #ddd;
            padding: 10px 20px;
            border-radius: 20px;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scenario-btn.active {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .dwb-flow {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .flow-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #ddd;
            position: relative;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 8px;
            color: white;
        }

        .buffer-title {
            background: #4ecdc4;
        }

        .dwb-title {
            background: #ff6b6b;
        }

        .disk-title {
            background: #95a5a6;
        }

        .page-container {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .page-container.writing {
            border-color: #ff6b6b;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.3);
            animation: writePulse 1s infinite;
        }

        .page-container.written {
            border-color: #4caf50;
            background: #e8f5e8;
        }

        @keyframes writePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .page-header {
            background: #667eea;
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
        }

        .page-content {
            padding: 15px;
            text-align: center;
        }

        .page-data {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 5px;
            padding: 8px;
            margin: 5px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
        }

        .page-data.dirty {
            background: #fff3e0;
            border-color: #ff9800;
        }

        .page-data.new {
            background: #c8e6c9;
            border-color: #4caf50;
            animation: newDataPulse 1s ease;
        }

        @keyframes newDataPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .arrow {
            position: absolute;
            top: 50%;
            right: -30px;
            font-size: 2em;
            color: #ff6b6b;
            animation: arrowPulse 1s infinite;
            z-index: 10;
        }

        .arrow.hidden {
            display: none;
        }

        @keyframes arrowPulse {
            0%, 100% { opacity: 0.5; transform: translateY(-50%) scale(1); }
            50% { opacity: 1; transform: translateY(-50%) scale(1.1); }
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .step {
            background: #ddd;
            color: #666;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            margin: 5px;
            flex: 1;
            text-align: center;
            min-width: 150px;
        }

        .step.active {
            background: #ff6b6b;
            color: white;
            transform: scale(1.05);
        }

        .step.completed {
            background: #4caf50;
            color: white;
        }

        .operation-log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .log-entry.write {
            background: rgba(255, 152, 0, 0.2);
        }

        .log-entry.success {
            background: rgba(76, 175, 80, 0.2);
        }

        .log-entry.error {
            background: rgba(244, 67, 54, 0.2);
        }

        .log-entry.info {
            background: rgba(33, 150, 243, 0.2);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .crash-simulation {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .crash-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin: 0 10px;
        }

        .recovery-info {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .dwb-area {
            background: #fff5f5;
            border: 2px dashed #ff6b6b;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .dwb-area h4 {
            color: #ff6b6b;
            margin-bottom: 10px;
            text-align: center;
        }

        .dwb-pages {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .dwb-page {
            background: white;
            border: 1px solid #ff6b6b;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .dwb-page.writing {
            background: #ffebee;
            animation: dwbWritePulse 0.5s infinite;
        }

        @keyframes dwbWritePulse {
            0%, 100% { background: #ffebee; }
            50% { background: #ffcdd2; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›¡ï¸ MySQL åŒå†™ç¼“å†²(DWB)æœºåˆ¶</h1>
        <p>æ·±å…¥ç†è§£åŒå†™ç¼“å†²å¦‚ä½•é˜²æ­¢é¡µé¢æŸåå’Œæ•°æ®ä¸¢å¤±</p>
    </div>

    <div class="container">
        <div class="controls">
            <button class="btn" onclick="startNormalWrite()">æ­£å¸¸å†™å…¥æ¼”ç¤º</button>
            <button class="btn" onclick="startCrashSimulation()">å´©æºƒæ¢å¤æ¼”ç¤º</button>
            <button class="btn" onclick="resetDemo()">é‡ç½®æ¼”ç¤º</button>
        </div>

        <div class="scenario-selector">
            <button class="scenario-btn active" onclick="selectScenario('normal')">æ­£å¸¸å†™å…¥åœºæ™¯</button>
            <button class="scenario-btn" onclick="selectScenario('crash')">ç³»ç»Ÿå´©æºƒåœºæ™¯</button>
            <button class="scenario-btn" onclick="selectScenario('recovery')">æ¢å¤åœºæ™¯</button>
        </div>

        <div class="step-indicator">
            <div class="step" id="step1">1. è„é¡µäº§ç”Ÿ</div>
            <div class="step" id="step2">2. å†™å…¥DWB</div>
            <div class="step" id="step3">3. é¡ºåºå†™å…¥</div>
            <div class="step" id="step4">4. å†™å…¥å®é™…ä½ç½®</div>
            <div class="step" id="step5">5. éšæœºå†™å…¥</div>
            <div class="step" id="step6">6. å®Œæˆå†™å…¥</div>
        </div>

        <div class="dwb-flow">
            <div class="flow-section">
                <div class="section-title buffer-title">Buffer Pool</div>
                <div class="page-container" id="bufferPage1">
                    <div class="page-header">Page 100 (è„é¡µ)</div>
                    <div class="page-content">
                        <div class="page-data dirty" id="bufferData1">
                            id=1, name='å¼ ä¸‰', age=25<br>
                            id=2, name='æå››', age=28 (æ–°å¢)
                        </div>
                        <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
                            LSN: 12345<br>
                            Dirty: Yes
                        </div>
                    </div>
                </div>
                <div class="page-container" id="bufferPage2">
                    <div class="page-header">Page 200 (è„é¡µ)</div>
                    <div class="page-content">
                        <div class="page-data dirty" id="bufferData2">
                            id=3, name='ç‹äº”', age=30<br>
                            id=4, name='èµµå…­', age=32 (ä¿®æ”¹)
                        </div>
                        <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
                            LSN: 12346<br>
                            Dirty: Yes
                        </div>
                    </div>
                </div>
                <div class="arrow" id="arrow1">â¡ï¸</div>
            </div>

            <div class="flow-section">
                <div class="section-title dwb-title">Double Write Buffer</div>
                <div class="dwb-area">
                    <h4>DWBåŒºåŸŸ (2MB, 128é¡µ)</h4>
                    <div class="dwb-pages">
                        <div class="dwb-page" id="dwbPage1">
                            <div>Slot 1</div>
                            <div style="font-size: 0.7em; color: #666;">ç©ºé—²</div>
                        </div>
                        <div class="dwb-page" id="dwbPage2">
                            <div>Slot 2</div>
                            <div style="font-size: 0.7em; color: #666;">ç©ºé—²</div>
                        </div>
                        <div class="dwb-page" id="dwbPage3">
                            <div>Slot 3</div>
                            <div style="font-size: 0.7em; color: #666;">ç©ºé—²</div>
                        </div>
                        <div class="dwb-page" id="dwbPage4">
                            <div>Slot 4</div>
                            <div style="font-size: 0.7em; color: #666;">ç©ºé—²</div>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <div style="font-size: 0.9em; color: #666;">
                        å†™å…¥æ–¹å¼: é¡ºåºå†™å…¥<br>
                        æ€§èƒ½: é«˜æ•ˆ
                    </div>
                </div>
                <div class="arrow" id="arrow2">â¡ï¸</div>
            </div>

            <div class="flow-section">
                <div class="section-title disk-title">ç£ç›˜æ•°æ®æ–‡ä»¶</div>
                <div class="page-container" id="diskPage1">
                    <div class="page-header">Page 100 (åŸå§‹)</div>
                    <div class="page-content">
                        <div class="page-data" id="diskData1">
                            id=1, name='å¼ ä¸‰', age=25<br>
                            (åŸå§‹æ•°æ®)
                        </div>
                        <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
                            LSN: 12340<br>
                            Status: åŸå§‹
                        </div>
                    </div>
                </div>
                <div class="page-container" id="diskPage2">
                    <div class="page-header">Page 200 (åŸå§‹)</div>
                    <div class="page-content">
                        <div class="page-data" id="diskData2">
                            id=3, name='ç‹äº”', age=30<br>
                            (åŸå§‹æ•°æ®)
                        </div>
                        <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
                            LSN: 12341<br>
                            Status: åŸå§‹
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <div style="font-size: 0.9em; color: #666;">
                        å†™å…¥æ–¹å¼: éšæœºå†™å…¥<br>
                        æ€§èƒ½: è¾ƒä½
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="dwbWrites">0</div>
                <div class="stat-label">DWBå†™å…¥æ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="diskWrites">0</div>
                <div class="stat-label">ç£ç›˜å†™å…¥æ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pagesProtected">0</div>
                <div class="stat-label">ä¿æŠ¤é¡µé¢æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="crashRecoveries">0</div>
                <div class="stat-label">å´©æºƒæ¢å¤æ¬¡æ•°</div>
            </div>
        </div>

        <div class="crash-simulation" id="crashSimulation" style="display: none;">
            <h3>ğŸš¨ ç³»ç»Ÿå´©æºƒæ¨¡æ‹Ÿ</h3>
            <p>æ¨¡æ‹Ÿåœ¨ä¸åŒé˜¶æ®µå‘ç”Ÿç³»ç»Ÿå´©æºƒçš„æƒ…å†µ</p>
            <button class="crash-btn" onclick="simulateCrash('dwb')">DWBå†™å…¥æ—¶å´©æºƒ</button>
            <button class="crash-btn" onclick="simulateCrash('disk')">ç£ç›˜å†™å…¥æ—¶å´©æºƒ</button>
            <button class="crash-btn" onclick="recoverFromCrash()">å¯åŠ¨æ¢å¤</button>
        </div>

        <div class="operation-log" id="operationLog">
            <div class="log-entry info">åŒå†™ç¼“å†²æ¼”ç¤ºå·²å¯åŠ¨...</div>
        </div>

        <div class="recovery-info" id="recoveryInfo" style="display: none;">
            <h3>ğŸ”§ æ¢å¤æœºåˆ¶è¯´æ˜</h3>
            <p><strong>DWBçš„ä½œç”¨ï¼š</strong></p>
            <ul>
                <li>é˜²æ­¢é¡µé¢åŠå†™é—®é¢˜ï¼ˆpartial page writeï¼‰</li>
                <li>åœ¨ç³»ç»Ÿå´©æºƒæ—¶æä¾›å®Œæ•´çš„é¡µé¢å‰¯æœ¬</li>
                <li>ç¡®ä¿æ•°æ®æ–‡ä»¶çš„ä¸€è‡´æ€§</li>
            </ul>
            <p><strong>æ¢å¤è¿‡ç¨‹ï¼š</strong></p>
            <ol>
                <li>æ£€æŸ¥DWBä¸­çš„é¡µé¢</li>
                <li>éªŒè¯é¡µé¢å®Œæ•´æ€§</li>
                <li>å¦‚æœæ•°æ®æ–‡ä»¶é¡µé¢æŸåï¼Œä»DWBæ¢å¤</li>
                <li>é‡æ–°åº”ç”¨Redo Log</li>
            </ol>
        </div>
    </div>

    <script>
        class DoubleWriteBufferDemo {
            constructor() {
                this.dwbWrites = 0;
                this.diskWrites = 0;
                this.pagesProtected = 0;
                this.crashRecoveries = 0;
                this.currentScenario = 'normal';
                this.crashPoint = null;
                this.initializeUI();
            }

            initializeUI() {
                this.updateStats();
            }

            selectScenario(scenario) {
                this.currentScenario = scenario;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.scenario-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // æ˜¾ç¤º/éšè—ç›¸å…³UI
                const crashSim = document.getElementById('crashSimulation');
                const recoveryInfo = document.getElementById('recoveryInfo');
                
                if (scenario === 'crash') {
                    crashSim.style.display = 'block';
                    recoveryInfo.style.display = 'none';
                } else if (scenario === 'recovery') {
                    crashSim.style.display = 'none';
                    recoveryInfo.style.display = 'block';
                } else {
                    crashSim.style.display = 'none';
                    recoveryInfo.style.display = 'none';
                }
                
                this.log(`åˆ‡æ¢åˆ°${scenario === 'normal' ? 'æ­£å¸¸å†™å…¥' : scenario === 'crash' ? 'å´©æºƒæ¨¡æ‹Ÿ' : 'æ¢å¤'}åœºæ™¯`, 'info');
            }

            async startNormalWrite() {
                this.log('å¼€å§‹æ­£å¸¸çš„åŒå†™ç¼“å†²å†™å…¥æµç¨‹', 'info');
                await this.executeNormalWriteSteps();
            }

            async executeNormalWriteSteps() {
                // æ­¥éª¤1: è„é¡µäº§ç”Ÿ
                await this.activateStep(1, 'äº‹åŠ¡æäº¤ï¼ŒBuffer Poolä¸­äº§ç”Ÿè„é¡µ');
                this.highlightDirtyPages();
                
                // æ­¥éª¤2: å†™å…¥DWB
                await this.activateStep(2, 'å°†è„é¡µå…ˆå†™å…¥Double Write Buffer');
                await this.writeToDWB();
                
                // æ­¥éª¤3: é¡ºåºå†™å…¥å®Œæˆ
                await this.activateStep(3, 'DWBé¡ºåºå†™å…¥å®Œæˆï¼Œæ€§èƒ½é«˜æ•ˆ');
                
                // æ­¥éª¤4: å†™å…¥å®é™…ä½ç½®
                await this.activateStep(4, 'ä»DWBå†™å…¥åˆ°æ•°æ®æ–‡ä»¶çš„å®é™…ä½ç½®');
                await this.writeToDisk();
                
                // æ­¥éª¤5: éšæœºå†™å…¥
                await this.activateStep(5, 'éšæœºå†™å…¥åˆ°ç£ç›˜ï¼Œæ€§èƒ½ç›¸å¯¹è¾ƒä½');
                
                // æ­¥éª¤6: å®Œæˆå†™å…¥
                await this.activateStep(6, 'åŒå†™ç¼“å†²å†™å…¥æµç¨‹å®Œæˆ');
                this.completeWrite();
                
                this.updateStats();
            }

            async activateStep(stepNum, description) {
                // é‡ç½®æ‰€æœ‰æ­¥éª¤
                for (let i = 1; i <= 6; i++) {
                    const step = document.getElementById(`step${i}`);
                    step.classList.remove('active', 'completed');
                }
                
                // æ¿€æ´»å½“å‰æ­¥éª¤
                const currentStep = document.getElementById(`step${stepNum}`);
                currentStep.classList.add('active');
                
                // æ ‡è®°ä¹‹å‰çš„æ­¥éª¤ä¸ºå®Œæˆ
                for (let i = 1; i < stepNum; i++) {
                    document.getElementById(`step${i}`).classList.add('completed');
                }
                
                this.log(`æ­¥éª¤${stepNum}: ${description}`, 'info');
                await this.sleep(1500);
            }

            highlightDirtyPages() {
                const bufferPage1 = document.getElementById('bufferPage1');
                const bufferPage2 = document.getElementById('bufferPage2');
                
                bufferPage1.classList.add('writing');
                bufferPage2.classList.add('writing');
                
                setTimeout(() => {
                    bufferPage1.classList.remove('writing');
                    bufferPage2.classList.remove('writing');
                }, 1000);
            }

            async writeToDWB() {
                this.dwbWrites++;
                
                // æ˜¾ç¤ºç®­å¤´åŠ¨ç”»
                const arrow1 = document.getElementById('arrow1');
                arrow1.style.display = 'block';
                
                // å†™å…¥DWBæ§½ä½
                const dwbPage1 = document.getElementById('dwbPage1');
                const dwbPage2 = document.getElementById('dwbPage2');
                
                dwbPage1.classList.add('writing');
                dwbPage1.innerHTML = `
                    <div>Slot 1</div>
                    <div style="font-size: 0.7em; color: #ff6b6b;">å†™å…¥ä¸­...</div>
                `;
                
                await this.sleep(800);
                
                dwbPage1.classList.remove('writing');
                dwbPage1.innerHTML = `
                    <div>Slot 1</div>
                    <div style="font-size: 0.7em; color: #4caf50;">Page 100</div>
                `;
                
                dwbPage2.classList.add('writing');
                dwbPage2.innerHTML = `
                    <div>Slot 2</div>
                    <div style="font-size: 0.7em; color: #ff6b6b;">å†™å…¥ä¸­...</div>
                `;
                
                await this.sleep(800);
                
                dwbPage2.classList.remove('writing');
                dwbPage2.innerHTML = `
                    <div>Slot 2</div>
                    <div style="font-size: 0.7em; color: #4caf50;">Page 200</div>
                `;
                
                this.log('è„é¡µå·²æˆåŠŸå†™å…¥Double Write Buffer', 'success');
                this.pagesProtected += 2;
                
                // éšè—ç®­å¤´
                setTimeout(() => {
                    arrow1.style.display = 'none';
                }, 500);
            }

            async writeToDisk() {
                this.diskWrites++;
                
                // æ˜¾ç¤ºç®­å¤´åŠ¨ç”»
                const arrow2 = document.getElementById('arrow2');
                arrow2.style.display = 'block';
                
                // å†™å…¥ç£ç›˜
                const diskPage1 = document.getElementById('diskPage1');
                const diskPage2 = document.getElementById('diskPage2');
                
                diskPage1.classList.add('writing');
                await this.sleep(1000);
                
                diskPage1.classList.remove('writing');
                diskPage1.classList.add('written');
                document.getElementById('diskData1').innerHTML = `
                    id=1, name='å¼ ä¸‰', age=25<br>
                    id=2, name='æå››', age=28 (æ–°å¢)
                `;
                
                diskPage2.classList.add('writing');
                await this.sleep(1000);
                
                diskPage2.classList.remove('writing');
                diskPage2.classList.add('written');
                document.getElementById('diskData2').innerHTML = `
                    id=3, name='ç‹äº”', age=30<br>
                    id=4, name='èµµå…­', age=32 (ä¿®æ”¹)
                `;
                
                this.log('è„é¡µå·²æˆåŠŸå†™å…¥ç£ç›˜æ•°æ®æ–‡ä»¶', 'success');
                
                // éšè—ç®­å¤´
                setTimeout(() => {
                    arrow2.style.display = 'none';
                }, 500);
            }

            completeWrite() {
                // æ¸…ç†DWB
                setTimeout(() => {
                    document.getElementById('dwbPage1').innerHTML = `
                        <div>Slot 1</div>
                        <div style="font-size: 0.7em; color: #666;">ç©ºé—²</div>
                    `;
                    document.getElementById('dwbPage2').innerHTML = `
                        <div>Slot 2</div>
                        <div style="font-size: 0.7em; color: #666;">ç©ºé—²</div>
                    `;
                }, 2000);
                
                this.log('åŒå†™ç¼“å†²å†™å…¥æµç¨‹å®Œæˆï¼ŒDWBç©ºé—´å·²é‡Šæ”¾', 'success');
            }

            async startCrashSimulation() {
                this.selectScenario('crash');
                this.log('å¼€å§‹å´©æºƒåœºæ™¯æ¨¡æ‹Ÿ', 'info');
            }

            async simulateCrash(crashPoint) {
                this.crashPoint = crashPoint;
                
                if (crashPoint === 'dwb') {
                    this.log('ğŸš¨ æ¨¡æ‹Ÿåœ¨DWBå†™å…¥è¿‡ç¨‹ä¸­ç³»ç»Ÿå´©æºƒ', 'error');
                    
                    // å¼€å§‹å†™å…¥DWB
                    await this.activateStep(2, 'å¼€å§‹å†™å…¥DWB...');
                    const dwbPage1 = document.getElementById('dwbPage1');
                    dwbPage1.classList.add('writing');
                    dwbPage1.innerHTML = `
                        <div>Slot 1</div>
                        <div style="font-size: 0.7em; color: #ff6b6b;">å†™å…¥ä¸­...</div>
                    `;
                    
                    await this.sleep(500);
                    
                    // æ¨¡æ‹Ÿå´©æºƒ
                    this.log('ğŸ’¥ ç³»ç»Ÿå´©æºƒï¼DWBå†™å…¥æœªå®Œæˆ', 'error');
                    dwbPage1.classList.remove('writing');
                    dwbPage1.innerHTML = `
                        <div>Slot 1</div>
                        <div style="font-size: 0.7em; color: #f44336;">æŸå</div>
                    `;
                    
                } else if (crashPoint === 'disk') {
                    this.log('ğŸš¨ æ¨¡æ‹Ÿåœ¨ç£ç›˜å†™å…¥è¿‡ç¨‹ä¸­ç³»ç»Ÿå´©æºƒ', 'error');
                    
                    // å…ˆå®ŒæˆDWBå†™å…¥
                    await this.writeToDWB();
                    await this.activateStep(4, 'å¼€å§‹å†™å…¥ç£ç›˜...');
                    
                    const diskPage1 = document.getElementById('diskPage1');
                    diskPage1.classList.add('writing');
                    
                    await this.sleep(500);
                    
                    // æ¨¡æ‹Ÿå´©æºƒ
                    this.log('ğŸ’¥ ç³»ç»Ÿå´©æºƒï¼ç£ç›˜å†™å…¥æœªå®Œæˆï¼Œé¡µé¢å¯èƒ½æŸå', 'error');
                    diskPage1.classList.remove('writing');
                    diskPage1.style.background = '#ffebee';
                    diskPage1.style.borderColor = '#f44336';
                    document.getElementById('diskData1').innerHTML = `
                        id=1, name='å¼ ä¸‰', age=25<br>
                        <span style="color: #f44336;">é¡µé¢æŸåï¼</span>
                    `;
                }
            }

            async recoverFromCrash() {
                this.crashRecoveries++;
                this.log('ğŸ”§ å¼€å§‹ç³»ç»Ÿæ¢å¤æµç¨‹', 'info');
                
                if (this.crashPoint === 'dwb') {
                    this.log('æ£€æµ‹åˆ°DWBå†™å…¥æœªå®Œæˆï¼Œæ•°æ®æ–‡ä»¶å®Œæ•´ï¼Œæ— éœ€æ¢å¤', 'success');
                    
                    // é‡ç½®DWB
                    document.getElementById('dwbPage1').innerHTML = `
                        <div>Slot 1</div>
                        <div style="font-size: 0.7em; color: #666;">ç©ºé—²</div>
                    `;
                    
                } else if (this.crashPoint === 'disk') {
                    this.log('æ£€æµ‹åˆ°ç£ç›˜é¡µé¢æŸåï¼Œä»DWBæ¢å¤...', 'info');
                    
                    await this.sleep(1000);
                    
                    // ä»DWBæ¢å¤
                    const diskPage1 = document.getElementById('diskPage1');
                    diskPage1.style.background = '';
                    diskPage1.style.borderColor = '';
                    diskPage1.classList.add('written');
                    
                    document.getElementById('diskData1').innerHTML = `
                        id=1, name='å¼ ä¸‰', age=25<br>
                        id=2, name='æå››', age=28 (ä»DWBæ¢å¤)
                    `;
                    
                    this.log('âœ… é¡µé¢å·²ä»DWBæˆåŠŸæ¢å¤', 'success');
                    this.log('é‡æ–°åº”ç”¨Redo Logå®Œæˆæ•°æ®ä¸€è‡´æ€§', 'success');
                }
                
                this.crashPoint = null;
                this.updateStats();
            }

            updateStats() {
                document.getElementById('dwbWrites').textContent = this.dwbWrites;
                document.getElementById('diskWrites').textContent = this.diskWrites;
                document.getElementById('pagesProtected').textContent = this.pagesProtected;
                document.getElementById('crashRecoveries').textContent = this.crashRecoveries;
            }

            log(message, type = '') {
                const logContainer = document.getElementById('operationLog');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            reset() {
                this.dwbWrites = 0;
                this.diskWrites = 0;
                this.pagesProtected = 0;
                this.crashRecoveries = 0;
                this.crashPoint = null;

                // é‡ç½®UI
                document.querySelectorAll('.page-container').forEach(page => {
                    page.classList.remove('writing', 'written');
                    page.style.background = '';
                    page.style.borderColor = '';
                });

                // é‡ç½®DWB
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`dwbPage${i}`).innerHTML = `
                        <div>Slot ${i}</div>
                        <div style="font-size: 0.7em; color: #666;">ç©ºé—²</div>
                    `;
                    document.getElementById(`dwbPage${i}`).classList.remove('writing');
                }

                // é‡ç½®ç£ç›˜æ•°æ®
                document.getElementById('diskData1').innerHTML = `
                    id=1, name='å¼ ä¸‰', age=25<br>
                    (åŸå§‹æ•°æ®)
                `;
                document.getElementById('diskData2').innerHTML = `
                    id=3, name='ç‹äº”', age=30<br>
                    (åŸå§‹æ•°æ®)
                `;

                // é‡ç½®æ­¥éª¤
                for (let i = 1; i <= 6; i++) {
                    const step = document.getElementById(`step${i}`);
                    step.classList.remove('active', 'completed');
                }

                // éšè—ç®­å¤´
                document.getElementById('arrow1').style.display = 'none';
                document.getElementById('arrow2').style.display = 'none';

                document.getElementById('operationLog').innerHTML = 
                    '<div class="log-entry info">åŒå†™ç¼“å†²æ¼”ç¤ºå·²é‡ç½®...</div>';

                this.updateStats();
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // åˆå§‹åŒ–æ¼”ç¤º
        const demo = new DoubleWriteBufferDemo();

        function startNormalWrite() {
            demo.startNormalWrite();
        }

        function startCrashSimulation() {
            demo.startCrashSimulation();
        }

        function simulateCrash(crashPoint) {
            demo.simulateCrash(crashPoint);
        }

        function recoverFromCrash() {
            demo.recoverFromCrash();
        }

        function selectScenario(scenario) {
            demo.selectScenario(scenario);
        }

        function resetDemo() {
            demo.reset();
        }
    </script>
</body>
</html>